---
title: 硬件视角下的 C++ SeqCst Fences
tags: 微架构,Fences
---

考虑典中典 Store buffering litmus test，在 C++ 中的实现。

```
x.store(1, relaxed)  |  y.store(1, relaxed)
a = y.load(relaxed)  |  b = x.load(relaxed)
```

在 Sequentially consistent 的内存模型 (SC) 下，是肯定不会发生 `a == b == 0` 的，但是现实是一个远比 SC 更丑恶的地方。Store buffer 导致弱内存序中，特别是在 TSO 上也会发生 `a == b == 0` 的情况，而 TSO 中所有 Acquire 和 Release 语义全都是 No-op，所以两个线程两个访存之间分别加上 AcqRel Fence 也无法避免这个行为。

一种恢复 SC 中这段代码的行为的方法是把所有访问的 relaxed 都换成 `seq_cst`，C++ 标准要求所有 SeqCst Atomic 操作都在同一个全序内。另一种方法在两侧两个访存中间分别加上一个 SeqCst Fence，因此一种常见的定义/解释 SeqCst Fence 的方法是：

> 它是 AcqRel Fence，并且额外保证 $W \to R$ 顺序。

这是一个来自 ISA 和硬件视角的定义方法。但是 Virtually 没有任何一个语言的内存模型是直接这么定义的。这个刻画准确吗？它 Sound & complete 吗？

作为一个工科猪还是以 C++ 为例。这句话的前一半首先是对的，标准里说使用 `std::memory_order_seq_cst` 的 Fence 是一个...

> ...sequentially consistent acquire and release atomic fence<sup>[1]</sup>...

...That's a long name. Anyway，这意味着需要仔细看的只有后半部分。先说结论，在 [MCA](/post/mca) 系统中，$W \to R$ 是一个充分条件，但不必要。在更弱的系统中（e.g. IRIW 允许不同观测顺序），这个“先后”就很难定义了。

## In MCA Environment

在前一篇博文中简要提及了，如果满足 MCA，那么存在一个 Global total order $G$ 对所有线程的所有内存操作排序。这一排序中的一部分可以使用访存观测到，这个可以被观测结果确认的子序就是如下三者的并的闭包：

- `rf` / Read from: [atomic.order] $\P 3.1$
- `mo` / Modification: [atomic.order] $\P 3.2$
- `rb` / Read before 或者部分文献叫作 `fr` / From read: [atomic.order] $\P 3.3$

C++ 标准把这个叫作 _Coherence-ordered before_<sup>[2]</sup>。C++ 对于 SeqCst 操作的要求是所有 SeqCst 操作构成一个全序 $S$，然后 $S + $sequenced-before 和 Coherence-ordered before 兼容 ([atomics.order] $\P$ 4)。但是如果保持 SeqCst Fence 保持 $W \to R$，那么它会在 $G$ 中保证有一个位置正好可以把这个 Fence 插入进去。这个时候注意到 $S$ 和 Coherence-ordered before 都是 $G$ 的一个子序，一定兼容。

<figure>
<svg class="inline-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 333.81818182 101.45454545"><defs><style>.cls-1{fill:#231f20;}.cls-2{fill:#ed1c24;}</style></defs><path class="cls-1" d="M32.69598586,52.22019527c-1.38301334-.0123821-2.86089079-.00341099-4.12894488-.27793462-1.1675919-.25277436-2.13185397-.67090319-2.78090367-1.29164451-.07623533-.07291031-.55060832-.60475731-.37685777-.37355586-.17704037-.23557906-.33306296-.50128649-.45819123-.76702518-.12671998-.26911904-.00580825-.03305764.00922281.01380909-.03860572-.12037234-.06867907-.24241798-.10433309-.36340661-.11582415-.39303862.00136787.32717675-.02724791-.0851087-.01196918-.1724475-.01165274-.34420737-.00139331-.51672165.01813381-.3049235.00601267-.03674933-.00501615.01808567.03372986-.16770385.08337223-.33294463.13388999-.49597507.0011042-.00356348.16176441-.37568061.06650555-.17656566-.09848506.2058585.10591671-.16760787.10248513-.16267484.09881484-.14205016.17934791-.29747437.27780832-.44041178-.03117643.04525958-.17267156.20949679.01119614-.017842.2253143-.27858444.48250856-.53494777.74437899-.7785343.74798144-.69575707,1.789463-1.33073585,2.89597554-1.91220463,1.17534199-.61763844,2.45063054-1.14375663,3.81242601-1.30738824.31099036-.03736821,1.081459-.04580153,1.57174038-.00198307.29726871.02656812.0181346.0021175-.0350012-.00732657.16709643.02969881.33420572.0638503.49915587.10422653.32866836.0804509.6599926.17770926.97325267.30626035-.31473832-.12915771.23729386.13263201.32220525.18001381.11029161.06154434.21840587.12687003.32520422.19422675.04309682.02718076.46465225.32388895.25962745.16614771-.079674-.0612993.30839073.28405581.40159339.37927418.03699368.03779375.37393349.41864167.2097712.21362481-.12399905-.15485831.13788413.21147659.16175556.25016739.06518825.10565709.12447689.21358266.1849638.3219664.3424344.61359267-.02044435-.14536678.07838103.19699663.03086269.10691845.05652423.21587464.08836274.32242259.13307052.44532208.01931217-.16302119.00986607.10810106-.00593493.1703446-.05958085.80881632.02230897.33863528-.05140344.29513954-.132037.583845-.23270668.86575278.15081776-.42233869-.15611422.24301714-.24446168.39758718-.01792554.03136198-.23734515.31062187-.06538325.10065143.19149826-.23382489-.24916213.23629574-.24333671.23012697-.03073291.03254428-.30570674.23154273-.08098147.07538364.23122789-.16067769-.15178297.074341-.19476441.09629757-.33772753.17252421.33745764-.18359877.00717978-.0002047-.10260398.05697313-.60974472.1177988-.08436536.05917159-1.34170958.1497217-2.5,1.04184118-2.5,2.5,0,1.23528695,1.14945026,2.65070817,2.5,2.5,2.04215251-.2278843,3.67577246-1.15197574,4.85446336-2.85574942.91059133-1.31624122,1.38434019-3.0455821,1.23745779-4.64125895-.35427175-3.84867916-3.72038253-6.68933394-7.41172068-7.27079987-6.76810669-1.0661238-19.07375367,5.50559237-14.791933,13.73276968,2.30367924,4.42633615,7.56054511,5.03281384,12.00636448,5.07261721,1.35101965.01209566,2.5-1.15767647,2.5-2.5,0-1.36556845-1.14428351-2.48786229-2.5-2.5h0Z"/><path class="cls-1" d="M47.72306277,51.75668575c10.542117-.41197666,21.09059019-.63528841,31.64069739-.66983527,3.21677299-.01053349,3.22301127-5.01055391,0-5-10.55010721.03454686-21.09858039.25785861-31.64069739.66983527-3.2069467.12532466-3.22310496,5.12595611,0,5h0Z"/><path class="cls-2" d="M91.85900578,49.73371439c-1.23261258.10980078-2.47395992.21706211-3.7114164.12426726-.13537282-.01015139-.27236668-.01873319-.40694183-.0370577.12663565.01724342.34821361.07302557-.13900776-.03648799-.26530094-.05963214-.52508528-.12898179-.78660506-.203085.00147923.00041915-.42066907-.14445136-.19014446-.05451911.23720713.09253924-.18795718-.09422977-.23652403-.12041951-.11739767-.06330686-.67879234-.43654143-.34945875-.17962942-.21173816-.16517621-.39223957-.36132175-.58207646-.54971099-.19551797-.19402701-.00284583.02527453.02989101.06826603-.06789063-.08915706-.12901335-.18475028-.18870502-.27946649-.09320446-.14789287-.31383458-.73392153-.18306304-.29616252-.02832537-.09481944-.04897017-.22569202-.09243752-.31328172-.13287788-.26775805-.0203134.32196063-.0129013.02363801.00247913-.09978026.00612132-.22674335-.0069069-.32549875.04549515.34485845-.04783023.22103835.00043085.00916697-.00359965.01580285.12119537-.40202439.04807175-.20605088-.07130031.19108699.10312931-.19456257.09850208-.18652278.06191095-.10757011.12582847-.2138318.19380373-.3176489.0441269-.06739403.32157542-.39390929.11163687-.16444441-.16568016.18109003.27971512-.26343395.36281081-.3500042.07066099-.07361561.36503547-.30365824-.03270345-.0017595.08172306-.06203087.16687645-.11999763.25207734-.1770769.17133398-.11478307.34794855-.22061441.52958757-.31825892.16363891-.08796811.71221708-.28175105.25305063-.13248071.23272686-.07565713.46111904-.15761199.69823643-.21976576.23868925-.06256579.47874731-.10451675.72023039-.15249574-.44034079.08748897-.03667685.01154025.17530047.00035076.24637085-.01300501.49327565-.01323323.73971602-.0027729.20462017.00868524.76376625.11733448.27885073.0080457.47880334.10791124.94596118.20799443,1.40964042.37404739.05879076.02105417.50968042.21047668.24988642.09290644-.23609089-.10684335.11576968.06100943.13127543.06907245.24495633.12737775.4888856.25368605.72627991.39501623.23817488.14179488.46683783.29555258.69635756.45052704.36663997.24755969-.08846662-.09863818.25130459.18672807.42874923.36009691.83854082.73969139,1.22444202,1.14553097.22080372.232212.43424601.47170206.6404799.7169413.07729226.09191067.15306312.1850642.22848011.27850934.27354614.33893635-.31920164-.45708818.11890828.15954114.07177119.10101624.14561085.20038609.21423872.30361685.17026156.2561092.14752393.52345725.13345339.0570066-.01088429-.36082366-.04102251-.6015973.11436562-.97044407.18447054-.19457246.21331499-.22582593.08653335-.09376042-.10092249.09662925-.09761872.10110628.00991132.01343111.23207124-.19522653-.10323347.04761265-.10459724.04998327.06553665-.11392127.33119283-.08720741-.00242464-.00819993-.32585443.07716903-.65113201.13732972-.98204879.18773757-.81961711.12485052-1.5128721.33528881-2.28196612.66002956-1.20964447.5107579-1.56321987,2.38692818-.89687884,3.42047458.81132964,1.25843495,2.12612018,1.4434045,3.42047458.89687884-.36036536.15215996.049892.01933324.10417536.01362484.20266494-.02131208.40916133-.08223007.61163987-.11441546.37032169-.05886524.746148-.0977417,1.11178426-.18311199.90773897-.21194269,1.80282062-.66802996,2.47228892-1.32502487,1.67083207-1.63970149,1.48150462-3.8538417.16435995-5.62377102-1.92941334-2.59267285-4.41099304-4.80390041-7.56374385-5.74825545-2.76178575-.82724784-6.10033126-.45107717-8.45926586,1.27248067-1.41794952,1.03602619-2.6529931,2.4678259-3.07992122,4.21458604-.40925846,1.6744654-.06432033,3.52568474.9231653,4.94204063,1.15881164,1.66208969,2.80221678,2.82849054,4.77209532,3.33700448,1.96327543.50680938,3.98574997.39795938,5.98200122.22013389,1.29906094-.11571998,2.56418697-1.06693908,2.5-2.5-.05621405-1.25505454-1.10502901-2.62426362-2.5-2.5h0Z"/><path class="cls-1" d="M101.9980981,51.02648585c5.43887666-.53974709,10.89992668-.80286929,16.3654993-.78851637,1.30779651.00343435,2.56036171-1.15234323,2.5-2.5-.06080017-1.35744591-1.09839871-2.49631931-2.5-2.5-5.4655741-.01435292-10.92662411.24876942-16.3654993.78851637-1.29745092.12875735-2.56460646,1.05757357-2.5,2.5.05570978,1.24379609,1.10632794,2.63830621,2.5,2.5h0Z"/><path class="cls-1" d="M129.15062465,50.771595c.22211143.17127687-.26058312-.20872918-.32548622-.26069565-.20615114-.16506064-.41102545-.33174691-.61456936-.50001213-.47493609-.3926191-.94274286-.79393298-1.40304597-1.20360937-.82199101-.73158383-1.62004346-1.49005272-2.39264763-2.27360414-.17858503-.18111546-.35800925-.36187725-.5297582-.54953312-.0813295-.08886202-.17246387-.17781473-.24335276-.27542289.13359429.18394833.02299189.06368962.04104542.00972038.02674642-.07995575-.07891048-.14394624.01265595.06011507-.02891923-.06444826-.04067212-.3783314-.03271636-.10678833.00962504.32851861.03629096-.11547248.02630068-.11351342.00784353-.00153809-.11130325.40532491.03108532-.00218793.17024142-.48722706.05172681-.11047181.00843225-.03723828.05787468-.09789606.12198387-.19519079.17729928-.29413305.13674556-.24459574-.00332963.02178767-.04217469.0579414.08236267-.07665628.1561631-.16279015.23811972-.24023002.08169682-.07719439.16522282-.15384536.25315861-.22399489-.0543876.04338694-.28280261.16861031-.04981119.05733056.23597523-.11270486.45384351-.28002718.68838723-.40047166.12526797-.06432845.61794384-.28622386.23313366-.1251574.23855159-.09984835.48281248-.1886949.72745752-.27234853.53152799-.18175003,1.07476543-.32972385,1.62597783-.43814332.05438016-.01069618.57986856-.09900667.3056667-.05982744-.24306257.0347299.17576237-.01617184.18050428-.0165333.25714338-.01960113.51415874-.03601309.77214012-.03882012.25795801-.00280678.51461111.00959029.77207719.02290904.00448064.00023178.42496245.04111217.18038541.01076382-.21201956-.02630846.20938038.0406306.24880509.04864861.43704808.08888474.85057932.22787194,1.27181907.37027779.27099302.0916129-.05085614-.01686877-.08837338-.03680461.0973368.05172267.19868534.09629261.29651481.14727048.22878443.11921708.44491891.25523185.66447639.39004537.02472261.01518027.32877627.2202478.10351727.06065164-.24270234-.17195478.11986721.10283342.17237161.14951168.16369795.14553324.31984396.29860305.46804867.45989723.07416195.08071195.14510871.16365238.21651117.24680167-.03791757-.0441556-.1859021-.30421318-.06155192-.06748016.05475208.10423488.13290105.20816829.19744169.30701244.05914294.09057757.19131879.33991494.08403496.09179138.04962955.11478208.0629171.2513592.11502435.3630494.13570732.29088426.0147015-.23429444.01231115.08412077-.002472.32929126.02104825-.0694217.03517333-.11776303-.03949334.13516108-.06846461.27119018-.11870705.40337719.19770521-.5201591-.2577713.24386449-.09042034.06060909.20871995-.22855595-.5287691.45523897-.07722403.10000315-.23920532.18818564-.51791185.33098626-.78983672.4652283.33866199-.16718837-.30093603.1006918-.42586369.13923088-.58639022.18089621-1.18806353.30511303-1.78845177.42917062-1.28278416.26506034-2.14311394,1.84847792-1.74609855,3.07529661.43937264,1.35770701,1.70094083,2.03008024,3.07529661,1.74609855,1.44937343-.29948251,2.97243092-.66712802,4.19854986-1.53767155,1.48713994-1.05586824,2.5673428-2.56825935,2.70910771-4.42493183.26050283-3.41176412-2.73601906-6.10996984-5.62737203-7.27382313-2.83150186-1.13976149-6.16163908-.82928208-8.94851138.29098609-1.60949008.64698354-3.06319331,1.47182334-4.10794094,2.89594227-.99316998,1.35381229-1.4372696,3.28358025-.84030553,4.89579688.6371902,1.72085505,2.13319427,2.99846433,3.44446317,4.22178932,1.34903774,1.25856075,2.77298972,2.42059235,4.23332985,3.546705,1.04006447.80202532,2.84474293.19280877,3.42047458-.89687884.70058664-1.32600071.21348352-2.56424043-.89687884-3.42047458h0Z"/><path class="cls-1" d="M144.54045366,47.65878135c11.72140841-.50897927,23.45604478-.63695134,35.18576512-.38371837,3.21875384.06948969,3.21808674-4.93052472,0-5-11.72972072-.25323297-23.46435709-.12526088-35.18576512.38371837-3.20519852.13917949-3.22255524,5.13993317,0,5h0Z"/><path class="cls-1" d="M184.1690338,45.04305376l1.12858347.4812888.17901894.23414723c-.01681689.00563791-.13646609-.23267813-.15822481-.26773413-.23577657-.37986536.10771213.13768856.07188966.17408302-.00003659.00003717-.07150935-.25800146-.08328964-.29366542-.13315613-.40312028.05993026.15268663.01726841.21144121.01578987-.02174606-.01390133-.25580176-.01409521-.30779014.00001405.003768.02652256-.29332616.01197516-.31013418-.05961336.3793624-.07238709.4715532-.03832121.27657242.01291767-.07781822.02875305-.15505744.04750612-.23171768.04752411-.20161069.15768294-.40534409.19174655-.60645185-.01376357.08125856-.26723628.5061711-.05142997.16017418.05653643-.09064346.10299031-.18815079.15904361-.27932484.04430695-.07206791.15839294-.19638879.17822508-.267501-.02008143.07200607-.38598439.42090716-.08961614.13101959.07623764-.07457055.14500834-.15554911.22216024-.22967679.07120905-.06841778.43202589-.29588852.1235214-.12002453-.31271166.1782623.04113495-.01344213.11972721-.06234668.10537364-.06556944.21269048-.12717177.32232039-.18534091.07551312-.04006693.43470004-.22633615.12036601-.07208578-.31078888.15251069.0478556-.01331518.13342653-.04262508.26503373-.09077981.53548299-.16383168.80956953-.22161277.05008533-.01055865.36529395-.05581943.36980718-.06779574-.03033462.08049589-.55182982.05553852-.00715914.01267531.50664027-.03987038,1.01570429-.03668273,1.52247184-.00070115.12645094.00897829.25265346.02006215.37875195.03307871l.09436971.00975397c.24204514.02926965.25056495.02985202.02555943.00174712l-.16237039-.02059217c.07714586.01211761.15404233.02562992.23068941.04053695.12897729.02624714.25811751.05115749.38624097.08148048.20737219.04907879.41324286.10531135.61633606.16988997.08722499.02773539.54597742.25115088.60337723.21804364-.10788209.06222457-.47735759-.22368056-.16060818-.05671818.09327495.04916633.18817082.09455334.28057096.14539624.14156785.07789729.50880261.41715089.65344446.41692738-.06507114.00010055-.43925687-.40028581-.15453281-.10393526.06864259.07144555.14525179.13518293.21414159.20673041.03909805.0406064.1611716.20899874.19621902.21910267-.0670877-.01934091-.31761141-.50665255-.13356696-.15404023.04293328.08225623.09670103.17239963.14465077.25018705.17138109.27802639-.15367737.00567448-.07927528-.19847868-.0086099.02362484.0836887.2822612.08342273.28149107.14330283.41494495.00388764-.46088556-.01028261-.12911791-.00493595.11556512-.00542799.24007117.00036103.3555386.01685962.3362809.12815075-.45891207.01533307-.14369095-.03797359.10610108-.07157112.2275763-.094515.33795777-.06766859.32554902.2203484-.39578242.05011118-.10602972-.1205836.20523962-.24883565.41449223-.36537046.62168755-.16723543.29733949.29124387-.32071336.05817922-.06775009-.10426266.11316442-.20063494.23364303-.30694765.34526283-.16956808.17803286-.3479105.3480087-.53310011.50970796-.06989231.06102683-.1888302.1874545-.27901302.23388798.40909921-.21063764.1580512-.11717647.03847853-.03213564-.47879005.34051849-.96800046.66107816-1.48086185.94835546-.54225403.30374147-1.10206946.56672046-1.66838317.82165879-.33219541.14954493.39491235-.15097157.05273821-.02450052-.15396292.05690627-.30535233.12135047-.45888151.1796109-.3079737.1168682-.61817432.22782079-.92992824.33417694-1.18696731.40493884-2.3966089.73861709-3.60764739,1.06273048-1.26311408.33805052-2.159809,1.79688845-1.74609855,3.07529661.41962858,1.29669581,1.7215784,2.1083977,3.07529661,1.74609855,2.85482088-.76404317,5.77301315-1.61865621,8.31222413-3.1737549,2.8187299-1.72628553,5.46024023-4.5039973,4.73131223-8.07872675-.58412583-2.86460639-3.56632397-4.64837715-6.25130445-5.12824091-3.07482621-.54953758-6.68377408-.26561404-8.9818391,2.10835131-1.22006218,1.2603583-1.98921378,3.01464615-1.98262219,4.77992204.00775528,2.07692121,1.37398035,4.99274506,3.85884917,4.76822943,1.29886602-.11735659,2.56423962-1.06576364,2.5-2.5-.05615078-1.25364195-1.10518576-2.62602581-2.5-2.5h0Z"/><path class="cls-1" d="M203.17790087,48.77785694c11.266269-.50897728,22.54582957-.64870038,33.82124946-.41895336,3.21874954.06558497,3.2184192-4.93442176,0-5-11.27541978-.22974702-22.55498035-.09002392-33.82124946.41895336-3.20445877.14476813-3.22229899,5.1455741,0,5h0Z"/><path class="cls-2" d="M245.83767931,45.18478867c-.20238015.06200967-.40482717.11322117-.61095195.1608954-.46729678.10808023.30955487.0120719-.1700705.01288156-.21111874.00035639-.42028883.00072608-.63142652-.00525835-.04886955-.00138514-.39812346-.0433848-.08663408-.00056064.31949827.04392523-.12946811-.03323454-.18662908-.04618866-.20415566-.04626682-.40463276-.13225342-.60839715-.17225055-.26101449-.05123482.05639962.03887511.10642417.06066572-.09646937-.04202189-.19101875-.08906969-.28465862-.13696115-.22008189-.11255937-.41821268-.2557212-.63290818-.37584082.03308521.01851079.29441756.26275915.08811524.07165538-.10315447-.09555495-.21133785-.18441977-.31148313-.28357189-.07777758-.07700624-.14962897-.15862703-.2257047-.23720033.04311012.04452542.17443397.29663741.05066873.05765296-.05483272-.10587922-.29531867-.59982257-.23369468-.39921693.08063765.26250116.00832351-.09292449-.01409188-.12017362.03058612.03718181.00173956.41977193.02085307.13115571.0198375-.29954846-.03081825.11223297-.03988005.13671746.08727448-.23581093.09156627-.1956151-.00815049.00294558-.02593819.05164933-.26794589.26516396-.06323416.09489995.21599072-.17964504-.07476667.02201286-.10184245.04404249.16589895-.13498015.36530115-.24182354.55176349-.34515306.20071941-.11123019.40782375-.21167054.61508398-.30999528.11575174-.0549129.23251292-.10754626.34912741-.16057135.38823095-.17653022-.28566657.11038588.11021782-.04816346.99104068-.39690588,2.01566312-.70873086,3.05915624-.93399325.29219193-.06307646.58597535-.11856961.88081375-.16771835.12631652-.02105661.25280139-.04193057.37961862-.05979864-.05514338.0077695-.32589578.03904087-.02934041.00779809.55235061-.05819137,1.10539962-.09981659,1.66081695-.11293626.51211913-.01209691,1.02505467-.00346025,1.53643732.02668685.13686203.00806831.72757342.06953961.30304761.00396618.1175708.01816031.2343638.04164129.35008146.06901724.04865848.0115114.49216081.09614048.26092393.06116598-.19031312-.0287848.01218173.01889526.0758535.05723768-.00630582-.00379729-.36314483-.30251453-.15260497-.12070737.0652668.05635974.11917556.13567548.18756047.18672534-.00139426-.00104082-.29473578-.38057276-.12486715-.1543339.01501732.02000075.14632286.21091124.13519514.22935337-.01621669.02687616-.13648984-.48236788-.07320128-.18638677.03174505.14846181.2157197.4665336.16146893.61538911-.00752899.02065835.01580862-.50197831-.0411327-.20675146-.01689777.08761082-.01724395.28264799.00025608.3700711.05625565.28103057.04121923-.20647899.04180306-.20408472.02953849.12113622-.07481188.33520364-.10397507.44943207-.02270281.08892397-.05614268.17514279-.08669827.26154696.08227611-.23265791.12496066-.2516677-.01698551-.02948273-.05647881.08840493-.12939966.18842954-.17405271.28276549-.14099876.29788005.2224312-.21244692-.00891587.02293505-.18221104.18538896-.35671506.37537259-.54420205.55628079-.01741594.01680482-.29653526.26381592-.09237085.09130468.19581951-.16546011-.16011543.11314843-.19997057.14038847-.46808997.31992837-.96575612.58786477-1.47655088.83253406-1.18259062.56645767-1.58697471,2.35008257-.89687884,3.42047458.78308487,1.21462513,2.15555227,1.50277317,3.42047458.89687884,2.71463265-1.30030161,5.14518383-3.71015249,5.14254353-6.90613031-.00122652-1.48465547-.53570806-3.01345297-1.58747035-4.0813454-1.27692453-1.29650784-3.01298526-1.59334765-4.75518611-1.6714804-3.0219483-.13552578-6.12590649.41397142-8.91626288,1.57785386-1.5309826.63858644-3.22441763,1.36202477-4.09385422,2.87668873-.93189809,1.62347947-.76584203,3.63274266.21253084,5.20137324,1.88124885,3.01621656,5.86153385,4.31305638,9.21264043,3.28627085,1.24886117-.38265347,2.17016307-1.76489331,1.74609855-3.07529661-.40737887-1.25884293-1.73615861-2.15641302-3.07529661-1.74609855h0Z"/><path class="cls-1" d="M261.81818182,47.77272727h30.54545455c3.2172614,0,3.22259025-5,0-5h-30.54545455c-3.2172614,0-3.22259025,5,0,5h0Z"/><path class="cls-1" d="M296.79367903,48.05243384c-.14279266.32852065.29982605-.31379225.3938848-.3906452.10309227-.10814706.22597712-.1844563.36865455-.22892772.23775165-.08741361.26938285-.11192627.09489361-.07353796l.66459903-.08930242c-.07112377.00774283-.14220217.00734803-.2132352-.00118442l.66459903.08930242c-.23911207-.05206733-.1464698-.00244856.27792682.14885629-.2159456-.13451536-.14672957-.07863347.20764811.16764568-.17030846-.18869044-.11906614-.11900855.15372696.20904565-.0462328-.07184867-.0885596-.14592899-.1269804-.22224096-.22653558-.3772325.21096863.64912366.03913929.05087988-.04229545-.14725652-.07128571-.29641028-.09556408-.44751622l.08930242.66459903c-.04369673-.34482496-.0418686-.6843852.00175067-1.0289982l-.08930242.66459903c.02690022-.17098952.06046268-.33994239.10749395-.50665769.02088334-.07402675.043895-.14724629.06910891-.21991214.14125537-.4070945-.03521986.16948075-.10074111.2234775.0974125-.08027865.18110915-.34472136.25069458-.45241406.05302114-.08205727.23284009-.31800832-.02954112.01914809-.28438435.36543015-.03423069.05201036.0242946-.01102223.10356539-.11154144.23157231-.20218801.33289463-.31382531-.39343612.43348934-.38568763.28577589-.1803935.15609954.06610032-.04175301.13349055-.08077823.20244407-.11762371.39884584-.21312422-.12980706.09871974-.21020786.07504837.0407112.01198607.18423516-.06484415.22828641-.07836317.19248659-.05907282.38864607-.09746547.58748349-.12704466l-.66459903.08930242c.36417968-.0424485.7232213-.03907555,1.08697619.00490829l-.66459903-.08930242c.26404411.03937845.52236954.09500147.77691456.17604134.25089059.07987641.51284857.3175454-.07825197-.05327493.103093.06467425.22537382.1069804.33239506.16575851.10848747.05958338.21504661.12316595.31870211.19081813.21932833.14314762.3076156.34578733-.10661877-.09949273.18534212.19923298.40390155.36140759.58393081.57007207.35413706.41046564-.19639368-.29572339-.06288879-.08451014.08307184.13142495.17300653.25752686.25158491.39207996.06715119.11498586.13023851.23239883.18942654.3516706.09100488.18338699.17814735.58522754-.03575662-.10911295.17461908.56682025.34694939,1.10226675.43018429,1.69359734l-.08930242-.66459903c.08379448.67888138.09195397,1.35970481.01718124,2.03987995l.08930242-.66459903c-.02013034.14237764-.05207963.27846202-.07710547.41962246-.06198656.19235208-.0504584.18157364.03458448-.03233532.09726737-.20887602.09938969-.22353125.00636696-.0439657-.19145653.34510867.33615912-.40451678.14763967-.19289335-.32059551.35988605.35886654-.20186808.15886985-.11441529-.07824635.03421488-.17628124.08454955-.24735183.13423935.4463332-.31205885.45892191-.1781537.16329964-.09161866-.23061103.06750484-.4670577.10859666-.70458207.14232585l.66459903-.08930242c-.27818147.03426883-.55640846.05483209-.8362967.06864585-1.30413904.06436523-2.56253643,1.10378973-2.5,2.5.05819514,1.29928512,1.1010213,2.56904601,2.5,2.5,1.20244256-.05934605,2.49390081-.20728852,3.53133279-.87651124,1.45902964-.94118535,2.00208839-2.40498528,2.10641022-4.07699127.15277142-2.44852628-.61255909-4.94512798-2.24573814-6.78748542-1.64457367-1.85521149-4.35990732-2.68965775-6.76080517-2.12535526-1.11547815.26217987-2.22325143.92087234-2.96207659,1.79982651-.91523956,1.08882815-1.39637323,2.29629796-1.55346452,3.70252193-.16391479,1.46730549.33193842,2.99587838,1.28524613,4.11056157.65050864.76062644,1.67070698,1.2204746,2.67031714,1.20474974,1.10475419-.01737888,2.38717912-.63501075,2.84866625-1.69674636.27824153-.64014556.44544802-1.22399329.25202087-1.9263969-.15969159-.57989764-.60807206-1.20833377-1.14889971-1.49407768-.58020013-.30654619-1.28307569-.46020846-1.9263969-.25202087-.57671455.18663275-1.24118359.56707055-1.49407768,1.14889971h0Z"/><path class="cls-1" d="M30.35031904,10.00755918c-2.82212636-.48317056-5.89184194-.96697604-8.67650894-.01497981-3.06327467,1.04724404-5.17891902,3.63509074-6.56983378,6.47104523-.75151943,1.5322829-1.50437149,3.27534433-1.52678397,5.0119019-.01937397,1.5011284.62536495,2.96394989,1.68407413,4.01636748,2.13158027,2.11891291,5.35306304,2.5011965,8.13435336,1.67316053,1.6385754-.4878309,3.14498257-1.32097168,4.71184369-1.98756423-.31626896.13455087.1133094-.0329611.13126506-.05045858.56101674-.14533002.28982644-.37188217-.81357089-.67965643-.72066966-.059966-1.06450677-.35256274-1.03151131-.87779022-.1011444.28170125.00503342.84577087-.0148051,1.15447217-.00877853.13660001-.01955122.27298164-.03252772.40925767-.07717673.81049068.09970014-.37832029-.0672035.4186701-.09387634.44827385-.20098738.88785868-.33251802,1.32682959-.37529568,1.25251338.44996759,2.78007939,1.74609855,3.07529661,1.34604023.30658496,2.67340849-.40483544,3.07529661-1.74609855.42264741-1.41054526.69614542-2.9637946.6349559-4.44138648-.08739307-2.11034983-1.47585833-3.93590285-3.76114015-3.62882869-1.41796069.1905319-2.80191652,1.07235854-4.09971329,1.65493874-.04141039.0185891-.53592511.23274972-.30451343.13611096.20082944-.08386745-.19673102.07673121-.18658634.07287617-.32494895.12348276-.65130314.24245282-.98456812.341936-.29129505.0869547-.58593701.15250302-.88197303.21959167-.40973554.09285561.26216763-.01102886-.07715115.0206693-.16333676.01525844-.32721323.02272628-.49131218.0221278-.09954932-.00036306-.19862557-.00755205-.29801178-.01042826-.09489309-.00274618-.49867868-.08646468-.16451125-.00997792.32423072.07421237-.01400457-.01107658-.06268881-.02521278-.12829542-.03725252-.25994165-.06263909-.38818261-.10091192-.12832497-.03829791-.25235779-.08359857-.37845504-.12776827.09465943.03315757.44091242.23385615.05499661.01147326-.17277969-.0995638-.71166558-.47870637-.30216847-.13482659-.16605422-.13944588-.30266875-.32439322-.47004745-.45679287-.27233267-.21542018.30742263.29983669.06481032.06044891-.06201004-.06118587-.08640931-.16842195-.13373298-.24026214.24136867.36641223.10623449.27298364.05495569.08044147-.05914625-.22208295.03452398-.29197861-.00767143.10318761.01993522-.18669631-.01927864-.36838567.00709358-.55893554-.03614061.26113036.04614132-.10202821.06447239-.16334033.10514904-.35169309.21017086-.70031473.33573919-1.04553593.04568762-.12560759.09361173-.25036226.14223469-.37485131.16035422-.41055382-.12153839.26027855.05903719-.14178971.29205777-.65029366.62806829-1.28054862,1.00343877-1.88653687.16422044-.26511316.33557786-.52575453.51485231-.78095611.10209251-.14533119.20507267-.29263477.31449098-.43228115-.03683875.04701588-.16664795.2090177.01497808-.00622884.19660368-.23299668.39895616-.4610511.61667153-.67470274.12247272-.12018672.25069569-.2431097.38399225-.35233953-.22957954.1881289.11208892-.07282586.1992824-.12797297.13198965-.08347926.26660271-.16154977.40451647-.2348265.08451281-.04490359.55872979-.23975649.13993241-.08274159.28857487-.10819207.58321792-.19913673.88277809-.27171601.1703148-.04126492.94181322-.14378094.48652307-.10640436.35684539-.02929486.71049728-.05559463,1.06888365-.0600096.68828537-.00847901,1.37618582.03693813,2.06023025.11088067.1621089.01752334.32415344.03678175.48585845.05758266-.26926087-.03463636-.11964268-.016139.06056466.01204922.39725252.06213864.79393758.12633663,1.19027234.19419231,1.28416645.21985955,2.75510417-.34031562,3.07529661-1.74609855.27606805-1.21205783-.36774707-2.83931184-1.74609855-3.07529661h0Z"/><path class="cls-2" d="M96.5370648,58.00706031c14.14030874,7.34166633,28.67438881,13.90734586,43.5179811,19.69595596,1.25827803.4906953,2.74382117-.53973032,3.07529661-1.74609855.3889322-1.41547574-.48322463-2.58280904-1.74609855-3.07529661-14.44203409-5.63201298-28.56625206-12.04909023-42.32358342-19.19191422-2.85204602-1.48078593-5.38347181,2.83250213-2.52359574,4.31735343h0Z"/><path class="cls-2" d="M136.46662457,69.30790065c1.95363442,2.847267,4.01732976,5.61579818,6.16670791,8.3181769l.50596908-3.92644367c-.73433712.38180468-1.47629102.74818605-2.22803435,1.09454704-.35952998.16565117-.72148587.32547066-1.08415225.4840821-.6582181.28787041.46694394-.18733593-.19838795.08368672-.19994823.08144882-.39976054.16306954-.60043653.242721-1.5388404.61078997-3.10788756,1.14057358-4.69879197,1.59838855-1.25586798.36140145-2.16521497,1.78018345-1.74609855,3.07529661.41323412,1.27693627,1.72902057,2.13351675,3.07529661,1.74609855,3.45580622-.99447824,6.8139204-2.34874133,10.00420074-4.00746714.68744694-.35742501,1.09426382-1.08747094,1.19355092-1.8263772.11343513-.84419754-.17245693-1.45240817-.68758184-2.10006647-.25204444-.31689143-.50313586-.63452564-.75257248-.9534753-.11337966-.14497632-.22625275-.29034351-.33927934-.43559442.32414969.416566-.12099444-.15841087-.14815549-.19391007-.46971165-.61390814-.93401935-1.23195208-1.39304693-1.85388824-.93996101-1.27355254-1.8563082-2.56421277-2.75183414-3.86937071-.73845105-1.07623375-2.22889746-1.66510436-3.42047458-.89687884-1.07068871.69028716-1.68817626,2.26722144-.89687884,3.42047458h0Z"/><path class="cls-2" d="M174.22311304,79.87988872c2.63101377-2.55431661,6.75100212-3.6017601,10.08848874-4.89473001,3.97741013-1.54088158,7.97059121-3.04105489,11.97873014-4.50014169,8.01627405-2.9181722,16.09232361-5.67217613,24.22135954-8.25967589,4.60141087-1.46464472,9.22014143-2.87409285,13.85374171-4.23340736,3.08103929-.9038547,1.76982126-5.7305245-1.32919806-4.82139517-16.83591727,4.93899024-33.46543662,10.57401855-49.82869496,16.90600522-4.27006229,1.65235902-9.15846552,3.00430705-12.51996102,6.26781099-2.31284559,2.24542341,1.22460702,5.77909454,3.53553391,3.53553391h0Z"/><path class="cls-2" d="M227.72676418,54.04477399c1.47243739.01011554,2.94307036.08871417,4.40744148.24416097.15910997.01688994.31810764.03481531.47701835.05348088.07583864.00890797.72332056.08751933.33445297.03918946-.38731161-.04813648.16030586.02326832.23821513.03468529.18997268.02783894.37977247.05689823.56935624.08727638.7179464.11504088,1.43670944.24078597,2.14646789.39937386.0622608.01391151.2894528.11455651.34840108.08845125-.34924254-.16728314-.43943912-.20589635-.27058974-.11583963.16504138.09381278.08947056.03307736-.22671243-.18220626-.15928972-.15231258-.585857-.7613557-.43928014-1.01978011-.0340822.06008911-.00445235.57848841.01492824.09807191.01765248-.43757906-.03480728.05323315-.07041182.17001702-.0377447.12380366-.08125781.24557452-.12529945.36724536-.05819513.16077168-.12198083.31925062-.18279721.47899157-.21123647.55483592.23718672-.50545336-.01409938.03243121-.55782746,1.19404449-1.20663351,2.31953185-2.00128506,3.37300022-.36433471.48299798-.40457982,1.37240043-.25202087,1.9263969.15969159.57989764.60807206,1.20833377,1.14889971,1.49407768.58020013.30654619,1.28307569.46020846,1.9263969.25202087.65927884-.21335169,1.07991483-.59984464,1.49407768-1.14889971,1.03236301-1.3686021,1.80993673-2.8567199,2.45527869-4.4414242.32411645-.79590164.58598486-1.58754808.60772817-2.46038855.03262656-1.30972611-.65603603-2.61638255-1.81180729-3.25690734-.81866495-.45370153-1.75406675-.58630934-2.66142313-.74797706-.97613173-.17392173-1.95869882-.31122642-2.94253724-.43337004-1.7155995-.21299182-3.4418528-.32020295-5.17039878-.33207793-1.30794357-.00898548-2.56018387,1.15631369-2.5,2.5.06101304,1.36219848,1.09831737,2.49037054,2.5,2.5h0Z"/><path class="cls-1" d="M275.99695758,25.92705402c4.25760875-.4652173,8.53987146-.63552397,12.82097627-.50989389,1.30833849.03839352,2.5592423-1.17733563,2.5-2.5-.0621399-1.38735716-1.09822273-2.4588645-2.5-2.5-4.28110692-.12563014-8.56336962.04467682-12.82097627.50989389-1.295739.14158187-2.56501927,1.04835688-2.5,2.5.05521316,1.23270842,1.1077183,2.65213083,2.5,2.5h0Z"/><path class="cls-1" d="M285.8656149,17.77772551l4.02897331,2.72242898,2.06893224,1.39800407.98002054.66221245c.18148356.12263077.36327329.24482036.54445585.36789581.05166131.035093.55939735.39631106.27007857.17376665-.26118878-.20090677.06387158.08215153.10897263.11307719.12842009.13392587.09496626.08347968-.10036147-.15133858l-.10777181-.27863855c-.06975281-.34205661-.00590955-.72897009.11715133-1.04638468-.1631952.42093421.1421719-.10014913-.02286827.02567387-.61454.46851181-1.13601417,1.21983643-1.66335878,1.78556206-1.12474269,1.20660335-2.2494852,2.41320685-3.37422772,3.61981036-.89199511.95691628-1.01882577,2.60027058,0,3.53553391.9691327.889646,2.5830853,1.0217697,3.53553391,0,1.30233344-1.39711985,2.60466688-2.7942397,3.90700059-4.19135931.66514661-.71355703,1.42416931-1.41388991,1.9352737-2.25162514.70338249-1.15289227.65538172-2.66697088-.06118665-3.79604431-.57742216-.90982528-1.47292314-1.48528738-2.3473138-2.07612438l-2.39560575-1.61874155-4.90010268-3.31106227c-1.0863207-.73404084-2.81790934-.24359671-3.42047458.89687884-.66760115,1.26356906-.26246345,2.63709212.89687884,3.42047458h0Z"/><path class="cls-1" d="M304.62573169,21.77161597c2.17647303-.24753376,4.36873304-.30078106,6.55465535-.15920496.61449652.03979923,1.34279064-.30725673,1.76776695-.73223305.4336057-.4336057.76012615-1.14501564.73223305-1.76776695-.06391167-1.42691449-1.09922373-2.40927562-2.5-2.5-2.18592406-.14157621-4.37818407-.08832861-6.55465535.15920496-.68396813.07778879-1.2627244.22719049-1.76776695.73223305-.4336057.4336057-.76012615,1.14501564-.73223305,1.76776695.02895947.64655933.24134366,1.31713952.73223305,1.76776695.45649719.41905603,1.12317524.8055435,1.76776695.73223305h0Z"/><path class="cls-1" d="M303.79114549,12.27352752c-.30852816,5.10895442-.18117605,10.23694315.40864737,15.32183249.15858481,1.36716549.20969171,2.82766124,1.19273067,3.90021,1.12034834,1.22236073,2.60298017,1.23865499,4.11849908.97050023,2.32361852-.41113929,4.58615075-1.35989879,6.55446681-2.65286468,1.12724652-.74047625,1.60377638-2.21191097.89687884-3.42047458-.6553721-1.12047197-2.2870594-1.64140722-3.42047458-.89687884-1.52413291,1.0011867-2.98156403,1.64300789-4.75571341,2.02931256-.199148.04336264-.40218783.09287102-.60435572.11951038l.08869578-.00310027c-.54082247-.03578968-.40200544.13517672.41645108.51289921,1.1306164.82277839.63277991.63510055.60625776.16050397-.0260487-.14546631-.02942651-.15446533-.01013345-.02699704l-.04235359-.34622612c-.12124466-1.03950512-.23093456-2.07996249-.3179651-3.12294219-.34822602-4.17316375-.38403212-8.36575378-.13163153-12.54528512.08147732-1.34919259-1.20734262-2.5-2.5-2.5-1.42123413,0-2.41828274,1.14683416-2.5,2.5h0Z"/><path class="cls-2" d="M34.78223005,86.53757743c12.05935271-9.67816561,25.21779084-17.96757147,39.10037157-24.77016482,1.21225318-.59401531,1.54280393-2.31615391.89687884-3.42047458-.72335662-1.23670328-2.20368951-1.49311482-3.42047458-.89687884-14.28437785,6.99947766-27.70869491,15.5975331-40.11230973,25.55198434-1.05383696.84575092-.88143045,2.65410346,0,3.53553391,1.04134419,1.04134419,2.4790368.8478858,3.53553391,0h0Z"/><path class="cls-2" d="M65.99664711,57.07942182l10.12258173.87990945c.3843218.03340733.76851235.07143927,1.15320551.10024285.57164331.04280131-.41249813-.0370089-.07157071-.00341996.35073302.034555.2005329.08931622-.04839068-.05420477-.28311147-.1547461-.44710702-.40187387-.49198663-.74138332-.16546754-.59144473-.24511592-.73545077-.23894513-.43201812-.05436263.17696417-.0539673.48573118.00031734.12168972-.05683655.381155-.12739666.76047231-.20936417,1.13701025-.16394145.75310547-.3780903,1.49576742-.63896414,2.22099021-.05219888.14511159-.10783813.2888578-.1622196.43314805-.25672107.68115755.11987134-.22781371-.05922993.14991769-.18206495.3839819-.35907266.76672119-.55661548,1.14339751-.60696969,1.157375-.33405315,2.77011708.89687884,3.42047458,1.15247629.60890578,2.771939.33975435,3.42047458-.89687884.92155545-1.7572298,1.64101276-3.64274448,2.0137691-5.59498671.22965972-1.20280022.49126092-2.46108925-.00143454-3.62860033-.48488586-1.14900514-1.55082337-1.90569919-2.76467391-2.13303749-2.02544177-.3793387-4.16187656-.40929251-6.21340278-.58762225l-6.1504294-.53462853c-1.30639965-.11355931-2.5568399,1.23097252-2.5,2.5.06501535,1.45155553,1.10056522,2.37835357,2.5,2.5h0Z"/><path class="cls-2" d="M255.71720341,57.1808308c13.58397164,5.13073067,27.31263307,9.87115929,41.16825629,14.2151645,3.07746674.9648452,4.39411849-3.86048348,1.32919806-4.82139517-13.85562344-4.34400528-27.58428487-9.08443391-41.16825629-14.2151645-1.26334057-.47716974-2.74111864.52989477-3.07529661,1.74609855-.3858398,1.40422127.47817474,2.59639576,1.74609855,3.07529661h0Z"/><path class="cls-2" d="M294.83788956,63.8006524c2.54913771,2.31738524,5.09092773,4.64859629,7.56976654,7.04135273.10030402.09682077.29882493.24098096.35611248.36443274l-.16728035-.18983337c-.32649696-.97155402-.1926448-1.69162438.40155647-2.16021108.16296727-.12442245.1470935-.1298646-.04762133-.01632643l-.16095058.0707245c-.2232343.09971279-.45129098.19097765-.67645443.2862625-.78919683.33397292-1.57839364.66794587-2.36759044,1.00191884-1.61597439.68384941-3.23194875,1.3676989-4.8479231,2.0515484-1.20920801.51171374-1.56362169,2.38630491-.89687884,3.42047458.8108513,1.25769301,2.12660033,1.44442172,3.42047458.89687884,1.87903995-.79517383,3.7580799-1.59034766,5.63711991-2.38552136.84914718-.3593428,1.76439096-.66343783,2.5747916-1.10442436,1.46364431-.79645473,2.13603009-2.57456763,1.48434443-4.1188283-.45011977-1.066622-1.32174264-1.795127-2.1444545-2.57383405-.70668709-.66888816-1.41558612-1.33543991-2.12668098-1.99964026-1.48145728-1.38375977-2.97279582-2.75687734-4.47279756-4.12050783-.96761947-.87964925-2.59248841-1.02730325-3.53553391,0-.88022111.95886573-1.03347442,2.59601685,0,3.53553391h0Z"/><path class="cls-2" d="M25.91947921,74.59723327c-2.38284408,7.54780237.76554395,16.05677153,7.21950809,20.50651192,1.11211936.76676014,2.77490021.20685841,3.42047458-.89687884.72555699-1.24048337.21782372-2.65193344-.89687884-3.42047458-.1718527-.1184853-.34341655-.23718203-.51028205-.36268936-.35602974-.26778656.40234495.36583086-.17974879-.15179154-.28014567-.24911739-.5614751-.49330682-.82893186-.75661542-.26653025-.26239646-.52320338-.53463733-.76958891-.81604829-.13689629-.15635706-.27022755-.31584514-.40031016-.47790154-.26041343-.32442205.17801668.25034444-.06424015-.0881214-.46121287-.6443773-.88328964-1.31222546-1.25086661-2.01471717-.09666664-.18474366-.18934554-.37151609-.27890171-.55979991-.01818793-.03823848-.21293847-.45950086-.13067198-.27197302.09934622.22646138-.13716318-.34537676-.15669164-.39712896-.07367312-.19524051-.14320808-.39198873-.20947427-.58985738-.23851595-.71220074-.42869181-1.44007665-.56829973-2.17807804-.03872703-.20472049-.07497957-.41009437-.10491947-.61631664.03959999.2727597.00952872.08405273-.00456897-.07923783-.03583896-.41511509-.06915932-.82881266-.0787431-1.24566142-.01714848-.74587695.01057062-1.49975288.11030481-2.23973735-.0579604.43004106.02972186-.11944618.04423148-.19791329.03782761-.20456934.07948119-.40836442.12613241-.61112625.0935852-.40675264.20824364-.8073418.33386203-1.20524562.40637923-1.28723071-.4788893-2.7271038-1.74609855-3.07529661-1.34587928-.36980909-2.66736331.4539452-3.07529661,1.74609855h0Z"/><path class="cls-2" d="M141.91987424,63.02141932c4.67857218,7.49121994,5.44904734,16.78713637,2.21936403,24.98871852-.49486667,1.25668348.5427697,2.7446563,1.74609855,3.07529661,1.41895417.38988797,2.57861662-.48481026,3.07529661-1.74609855,3.68173626-9.34954281,2.59005257-20.33372757-2.72340577-28.84151232-1.70079477-2.72327266-6.02844759-.21616807-4.31735343,2.52359574h0Z"/><path class="cls-2" d="M167.2507335,66.40010818c-3.61594211,6.61383947-3.51233567,14.91547036.36465996,21.39857359,1.64986784,2.75890523,5.97450139.24748329,4.31735343-2.52359574-2.98070174-4.98432263-3.13311995-11.28765338-.36465996-16.35138211.64756461-1.18444606.29144118-2.72542786-.89687884-3.42047458-1.14289292-.66847647-2.77066242-.29167817-3.42047458.89687884h0Z"/><path class="cls-2" d="M304.61463664,62.043563c1.23158871,5.36355559,1.40676776,10.97818893.44458148,16.40202993-.2355829,1.32798006.3588885,2.69413102,1.74609855,3.07529661,1.20831816.33201123,2.83819588-.40956246,3.07529661-1.74609855,1.12557694-6.34487366.99874056-12.77477408-.44458148-19.06042606-.30225256-1.31630666-1.81373916-2.09279322-3.07529661-1.74609855-1.35096741.37126585-2.04926444,1.75501244-1.74609855,3.07529661h0Z"/><path class="cls-2" d="M156.22727273,60.81818182v30.54545455c0,3.2172614,5,3.22259025,5,0v-30.54545455c0-3.2172614-5-3.22259025-5,0h0Z"/></svg>
<figcaption>
高亮颜色表示 Fence 发生的线程的访存，G 的定义来自访存拿到 Grant 的 Wall-clock，因此可能不直接反映核心视角的真实执行时间，但这个拿到 Grant 的时刻一定在核心视角中的 Inflight 时段内。箭头表示请求、回应的方向，括号表示核心视角对应访存的执行时间。
</figcaption>
</figure>

讨论另一个方向是，第一个遇到的问题是什么叫必要性？删掉这个条件的话，直接恢复成 AcqRel Fence 那么一开始的 SB 就是一个反例。但是硬件实现确实可以比 AcqRel + preserves $W \to R$ 要更弱，例如如果整个系统现在只有一个 Inflight SeqCst 操作就是这个 Fence，那么硬件可以不保证任何序，然后一对 $W \to R$ 在 $G$ 中被交换顺序后被另一对访存观测到：

$$
R \to_{rb} W' \to_{hb} R' \to_{rb} W
$$

事实上这是 C++ 标准中明确允许的一件事：[atomics.order] $\P$ 6

> Note 4 : We do not require that S be consistent with “happens before” (6.9.2.2). This allows more efficient implementation of `memory_order::acquire` and `memory_order::release` on some machine architectures. It can produce surprising results when these are mixed with `memory_order::seq_cst` accesses. — end note

在 MCA + perserves $W \to R$ 时，$S$ 和 Happens before 也一致了。我暂时没有找到这里并未指名道姓的架构是啥，是否需要 Non-MCA，如果后续想通了将会更新本文。

## In Non-MCA Environment

在非 MCA 的系统中，“先后”变得模糊了，但是上述 Coherence-ordered before (cob) 是使用内存访问观测到的一个序，因此还是可以定义的，只不过这个序并不需要作为某个全局序的子序，本身也不一定是一个全序。此时，如果我们能明确定义“先后”，那么也许还可以说明保证 $W \to R$ 顺序是一个充分条件。

从硬件实现的角度，如果我们把“先后”的视角放在在核心上，即把这个先后解读为之前所有的访存都已经全局可见，后续访存才开始执行的话，可以把这些 Fence 发生的时间定义为这个同步点的 Wall-clock。对于其他 Sequentially-consisten 的 AMO，如果在其本身已经有一个全序 $S$<sup>[3]</sup> 以后也是以类似的方式控制前后的其他访存，那么可以在 $S$ 的基础上扩展，把 Fence 都加进去：

逐个处理每个 Fence F。可以找到目前 S 中所有和 F 相关的其他 SeqCst 访存或者 Fence K，相关指在 $(sb \cup (sb ; (rf \cup rb \cup mo)^+ ; sb))^+$ 序的前驱或后继。上述阻塞所有访存的实现方式保证了这是一个和 S 兼容的序，并且这里是一个传递闭包，这是为了避免首先添加的两个本身不直接通过观测相关的 SeqCst 操作后续由于倒序导致第三个和两者都相关的 SeqCst 访存无法插入。

---

[1] N4917 [atomics.fence]

[2] 注意到，在不考虑 Mix-sized access 时 (effectively all general-purposed hardware, 因为大家的缓存都是按缓存行访问的)，这个子序中的每一个连通分量只包含一个地址。所以基本所有硬件内存续都包含一个公理叫作：

$$
acyclic((rf \cup rb \cup mo)^+ ; po\_loc)
$$

意思是LSU、缓存等部件不能让相同地址的访存莫名其妙换顺序，用 C++ 术语是 Coherence-ordered before 和 Sequenced before 兼容 ([intro.races] $\P$ 14-17)。PTX 的文章中直接把这个叫 SC-per-location。这是 Full SC 的一个弱化：

$$
SC = acyclic((rf \cup rb \cup mo)^+ ; po)
$$

[3] 对于其他带访存的 SeqCst AMO，这个序的存在不是自然的，比如在 IRIW 中，两个写入线程只有一个写，前后没有别的访存需要进行排序。所以需要额外进行跨线程的同步。
