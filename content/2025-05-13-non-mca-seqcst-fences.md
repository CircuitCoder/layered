---
title: C++ SeqCst 在 Non-MCA 系统上的实现
tags: 微架构,Fences
---

[<del>昨天</del> <del>前天</del> 上周的文章](seqcst-fences)最后的命题伪证了：

> 这是一个错误结论：SeqCst ld/st/AMO 存在全序 + 所有 SeqCst 操作等待/阻拦前后所有类型其他访存 $\implies$ C++11 SeqCst Semantics

问题是 SeqCst ld/st/AMO 的全序可能和 Fence 不兼容，所以如何在 Non-MCA 系统上实现 `std::memory_order_seq_cst` 还是一个非常 Nontrivial 的事情，需要把 SeqCst ld/st/AMO 的实现方法也考虑进来。本文在上篇文章提出的设计的基础上细化一下 SeqCst ld/st/AMO 的实现，并且给出一个比较详细的证明，说明这一设计符合 C++11 SeqCst Semantics。这显然不是唯一的设计，也不是所有系统下都最自然的设计，不过可以认为是一个 MCA 系统[不再等待所有 ProbeAck](mca) 之后得到的 Non-MCA 系统一个比较直观的设计。

<details>
<summary>各种序和符号的定义</summary>

- $co$: Coherence order，和 C++ 标准中的 Modification order 基本同义。
- $rf$: Read-from，$W \to_{rf} R$ 表示 R 读到了 W 的值，可以理解为 “W 早于 R”。
- $fr$: From-read，部分文献称为 Read-before ($rb$)，$R \to_{fr} W$ 表示 R 读到了 W 在 $co$ 序之前某个操作写入的值，可以理解为“R 早于 W”
- $sw$: Synchronize-with，在本文中狭义解释为一个 Release 操作写入的值被一个 Acquire 操作读到。标准库中有别的 $sw$ 操作，这里不做讨论。
- $cob$: Coherence-ordered before
- $bwcb, ra, ppsc$ 都是本文中定义的关系，分别指 Base wall-clock before, read-after 和 partial preserved SC

分号 ($;$) 表示关系连接，即：

$$
a ; b := \{ (X, Y) \in dom(a) \times codom(b) \mid exists Z, XaZ \land ZbY \}
$$

中括号 ($[S]$) 表示 S 类型的操作上的 Identity 关系，即：

$$
[S] := \{ (X, X) \mid X \in S \}
$$

中括号可以用于固定一个序的两端，例如 $[F]; sb; [F]$ 表示 $sb$ 关系中两端都是 Fence ($F$) 的子关系。
</details>

## The Hardware

实现很重要的一个属性是希望尽量在核心“局部”可以实现这个排序，不需要通过总线上或者其他信道上和别的核心进行访存之外的通信。很遗憾，SeqCst 的语义并不能完全在局部完成，需要的硬件功能集合包括：

1. 所有 SeqCst 操作会等待同一线程 sequenced-before 的所有操作完成，然后才开始本操作。等待本操作完成之后，才开始 sequenced-after 的其他操作。这里“完成”指的是全局可见之后，在硬件实现上需要核心发出的写操作对应的回应蕴含它已经全局可见了。
2. Acquire / Release 操作也要进行类似的等待。不过
    - Acquire 只阻止后面的请求。如果这是一个 ld/AMO，等待条件是带有 Acquire 的访存结束。如果是 Fence，等待条件是 Fence 之前所有访存结束。
    - Release 只等待之前的请求。如果这是一个 st/AMO，阻止的请求是带有 Release 的访存本身。如果是 Fence，阻止的请求是之后所有访存。
<!-- - 额外的，需要 SeqCst st/AMO 操作的全局可见顺序一致。<sup>[2]</sup> -->
3. 额外的，所有 SeqCst 操作结束时必须保证，该操作读取到的值必须全局可见。（对于 Fence，本线程之前所有 Load / AMO 读到的值都全局可见）。<sup>[2]</sup>

可以画一张图，横轴方向 Wall clock，每个线程一条时间轴，Fence 标记为一个点，其他访存标记为核心视角开始执行到收到回应结束执行的时刻。

<figure>
<svg class="inline-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 537 132"><path d="M58.04099965,24.2125931c.01831612,2.39700308.24411632,4.78380396.65564577,7.14554487.37011111,2.12404375.802947,4.46936069,1.78459699,6.40858703,1.13087712,2.234021,3.2974553,2.67184596,5.59620868,2.59166984,2.49481719-.08701445,4.98941147-.18098224,7.48410535-.27147286,9.72933688-.35291455,19.45867378-.70582851,29.1880107-1.05874224,5.57150059-.2020959,11.14300119-.40419172,16.71450179-.60628755,3.20801233-.11636468,3.22339567-5.11692268,0-5-17.95707908.65135966-35.92195827,1.52692424-53.88555819,1.95460085-.1172196.00279076-.62255603.06974832-.76787875.00563999-.18572709-.08193249.05585847.06634112.07680309.09396291-.14822435-.19547841-.23404742-.72871135-.2934682-.92370633-.33900682-1.11248345-.62374045-2.24192328-.85815398-3.38093255-.47263724-2.29653209-.67690801-4.61563242-.69481325-6.95886395-.0245744-3.21601439-5.02463133-3.22346514-5,0h0Z"/><path d="M123.54917305,25.71627823c-1.03128451,3.18371748-1.43214314,6.61611863-1.13397013,9.95022993.11617157,1.29900736,1.06661474,2.5642015,2.5,2.5,1.25466478-.05619659,2.62474984-1.10507208,2.5-2.5-.1372401-1.53459148-.12966177-3.07764058.03685816-4.60975581.00919655-.0866428.01904614-.17321213.02954876-.25970799.03516862-.27940424.02814408-.23063387-.02107363.1463111-.02518379-.1468121.05613941-.37385317.0799431-.51660737.06210037-.37242491.1332162-.74328349.21341405-1.11223578.16666532-.76674812.37491114-1.52267809.61667486-2.26903602.40320327-1.24474409-.46997527-2.7846365-1.74609855-3.07529661-1.37044825-.31214433-2.64358392.41334193-3.07529661,1.74609855h0Z"/><path d="M132.54271059,33.12999448c19.45059166-.52346332,38.9106795-.64325382,58.36624153-.35928521,3.21859898.04697788,3.21987364-4.95300351,0-5-19.45556197-.28396861-38.91564981-.16417811-58.36624153.35928521-3.211205.08642143-3.22399942,5.08676576,0,5h0Z"/><path d="M202.17527059,30.90478704c-.07707293-.0342412-.15037812-.07936919-.22713261-.11299686-.37501539-.16430173.22735883.09859745.22502639.190253.00068544-.02693521-.15216473-.15521727-.17268281-.17177439-.14642545-.11815841.34264127.54735148.18612641.23328872-.02844044-.05706858-.06340127-.11661302-.09684073-.17095667-.19208507-.31216422.15271216.48001825.11782718.2765627-.03134566-.18281364-.09666267-.35623136-.12259018-.54272769l.08930242.66459903c-.02492457-.24291031-.02382671-.47879825.00239722-.72155868l-.08930242.66459903c.01972507-.1375132.04393138-.27322457.08060469-.40738305.01821052-.06675021.03883784-.132745.06188195-.19798437.08903728-.23438796.04495418-.13067792-.1322493.31113011.0544322-.07724425.10544839-.18605154.15208233-.26895388.18978369-.33738323-.47888314.51619442-.06572183.10804564.06064287-.05914522.12367878-.11561899.18910772-.16942129-.34425613.2568385-.41131357.31364036-.20117232.17040557.10203269-.0534268.24032031-.11085528.32704564-.1812248-.40878603.16388143-.49258831.20017053-.25140683.1088673.07887458-.02771754.15861226-.0526781.23921302-.07488166.16288295-.04502193.32781871-.0758883.49460006-.10204446l-.66459903.08930242c.42963808-.05386757.85316021-.04884677,1.28241885.00654346l-.66459903-.08930242c.25701639.04003512.51045095.09280927.75942718.16902743.12340189.03777656.24269045.08964704.36580302.12712263-.69005776-.2100543-.29718955-.12740931-.09635125-.02474979.26021106.13300821.51102986.28427658.75244127.44885742.14171551.09661373.49673106.42170252-.03486491-.04420536.11011262.09650626.22839028.1848887.33941647.28058178.44824052.38633695.86333775.80969185,1.26489471,1.24380201.18410058.19902515.36546946.40063723.54536443.6034688.07334993.08270204.44549232.39849531.12864365.13750435-.13274233-.17812591-.14401191-.18311349-.03380875-.01496273-.13957196-.38902145-.17380484-.45763715-.10269864-.20584707l-.08930242-.66459903c.01737787.09121534.02189121.18304508.01354003.27548924l.08930242-.66459903c-.03841705.24544737-.19992487.47002468.08155191-.09257384-.16044204.32068171.14338045-.13758171.1464127-.16773555-.01510958.15025559-.45632548.45785531-.56439175.55475446-.18478501.16569009-.37659449.32183562-.56811247.47948844-.23682356.19494725.45197743-.32979349.09188891-.07564314-.12159154.08581927-.24188404.17282797-.36520892.2561997-.41055798.27755085-.8380474.53083031-1.27871348.75755997-.13222258.0680306-.26565241.1337918-.40015272.19720048-.08556497.04033866-.50070571.21431643-.10867439.05597204.40715784-.1644541-.06167062.0225787-.11426305.04290857-.13873563.05362897-.27871267.10375264-.41901444.15311126-1.23067107.43295414-2.18198389,1.72836575-1.74609855,3.07529661.39337569,1.21557166,1.75448228,2.21076539,3.07529661,1.74609855,2.09577076-.73729906,4.03806228-1.85370011,5.6417614-3.40481807,1.31943498-1.2761741,1.84208265-3.00961418.99821117-4.71590796-.45820366-.92648001-1.36922023-1.77793474-2.10240072-2.50491401-1.65207571-1.63810252-3.62998982-2.82891383-5.99191953-2.97407421-1.15236012-.07082219-2.33183691.21253871-3.34847378.75046647-1.13991682.60315823-1.91043628,1.59524801-2.37936446,2.76966505-.85043743,2.12989591-.04435174,5.15261682,2.16692582,6.13502123.63477034.28200946,1.22925555.4439989,1.9263969.25202087.57989764-.15969159,1.20833377-.60807206,1.49407768-1.14889971.57467963-1.08769644.37908814-2.85360066-.89687884-3.42047458h0Z"/><path d="M216.54148535,36.96271392c18.41941386-.75837838,36.85462841-1.11827812,55.28964883-1.06862079,5.20804452.0140286,10.41592695.06146098,15.62340385.13926611,3.21861401.04808945,3.21979278-4.95189294,0-5-18.4329622-.27540766-36.87127689-.15205946-55.29866441.38070007-5.20588816.15050894-10.4107389.33440593-15.61438827.54865461-3.20611905.13200482-3.22285512,5.13269389,0,5h0Z"/><path d="M299.03111105,30.24830466c-1.25569175,1.76821072-2.31523615,3.94783201-2.07768435,6.16969264.28931525,2.70601258,2.43790926,4.3177948,5.02077423,4.63214737,2.70515559.32923619,5.51379312.19219039,8.23709964.24980923,2.74758958.05813261,5.49517916.11626525,8.24276874.1743979,11.15687875.23605379,22.31375749.47210786,33.47063623.70816204,6.32778191.13388147,12.65556383.26776297,18.98334574.40164447,3.2187534.06810152,3.21820601-4.93191007,0-5-20.23225023-.42806849-40.46450046-.85613698-60.69675072-1.28420441-1.41542494-.0299471-2.83084989-.0598942-4.24627483-.0898413-1.15805023-.02450164-2.4237871.08867624-3.56431217-.11703431-.31239174-.05634447-.57710479-.2337432-.46009013-.03578419-.05319333-.08998957-.03032556-.38615214.01325946-.62052065.18122009-.97446971.83461163-1.87634765,1.39458157-2.66487306.78220214-1.10146317.19550657-2.78153988-.89687884-3.42047458-1.25357655-.73321517-2.63645764-.20713985-3.42047458.89687884h0Z"/><path d="M370.01218378,27.48128814c-.28565251,2.5402118-.26793812,5.10182694.05281688,7.63784182.08705442.68828642.22137623,1.25691014.73223305,1.76776695.4336057.4336057,1.14501564.76012615,1.76776695.73223305.64655933-.02895947,1.31713952-.24134366,1.76776695-.73223305.41566084-.45279866.81321726-1.12747398.73223305-1.76776695-.32075544-2.5360184-.33846899-5.09763354-.05281688-7.63784182.06687356-.59468408-.32732545-1.36285936-.73223305-1.76776695-.4336057-.4336057-1.14501564-.76012615-1.76776695-.73223305-.64655933.02895947-1.31713952.24134366-1.76776695.73223305-.47609294.51863014-.65396592,1.07176366-.73223305,1.76776695h0Z"/><path d="M381.81524851,38.4777232c20.38371814-.31738413,40.76743628-.63476826,61.15115441-.95215239,5.800245-.09031256,11.60049-.18062511,17.400735-.27093767,3.21432375-.05004854,3.2239749-5.05019881,0-5-20.38371814.31738413-40.76743628.63476826-61.15115441.95215239-5.800245.09031256-11.60049.18062511-17.400735.27093767-3.21432375.05004854-3.2239749,5.05019881,0,5h0Z"/><path d="M472.01839687,35.84255081c.80573722.29581914.43250996.21458361.30514849.11845908-.00571326-.00431201.51047769.45243995.25828748.19986334-.1772498-.17752138.02598836-.11543785.18843098.26717666-.0097624-.02299418-.11944414-.17721247-.10946127-.1809113.01926462-.00713789.26073332.71223026.08248757.14309769-.03300526-.10538467-.06681483-.39140533-.00153613.06135655.0676718.46936001.03424839.11792649.02862795.00039777-.01900572-.39742693-.12165398.69967996-.00138329.11752935.07660545-.37079616-.31820946.53801631-.05171828.1447908.15491995-.22859473-.37191827.40502359-.15809369.19053055.06133025-.06152199.13184884-.12479455.18568674-.1922329.14482933-.18141589-.24309208.17507657-.24909773.17798857.11567769-.05608952.22664291-.15256136.34064455-.21513513.0473565-.02599326.20369557-.1255126.2431004-.12025966.04900142.00653224-.5504091.18951161-.27869648.12733732.1792837-.04102436.3514722-.10745912.53283565-.14487727.10503182-.02166973.42891116-.06849809.00939484-.01141174-.40437812.05502639-.14548629.01801899-.05764452.01415863.22501764-.00988878.44792267-.01946505.6732703-.00898775.11075791.00514957.67545461.06891335.19598021.00560351-.4787462-.06321369.08070101.02455902.18921962.04933881.17223721.03932968.3430028.0860257.51125235.13991521.0841962.02696763.16675309.05926601.25097621.08595048.40261153.12755968-.43931421-.20749075-.16692857-.07668535.30097916.14453662.59528758.29353178.87676995.47414979.1454402.09332421.30952759.1875208.43700238.30454026-.01769055-.01623959-.48373568-.41193708-.19440296-.14072676.08089778.07583074.16696434.14622008.24785302.22223669.23347365.2194111.49978683.46360262.67421565.73395435-.01294092-.02005747-.36277611-.52179786-.15383367-.18598587.04660539.07490412.09945086.14650241.14680558.22096298.09480869.1490772.18329202.30240331.26503085.45903568.04092439.07842152.07697547.15901523.11751774.23752679.19345561.37463377-.11091258-.23432278-.09548635-.23166515.04481656.00772098.15639843.45601916.17000351.50319978.02762586.09580285.16976149.44467196.12455465.53586706-.02298826.04637387-.0320665-.59712802-.04798061-.30973521-.0048273.08717607-.03031564.26968403-.00033508.35355868-.14348489-.40141826.12553338-.5105954.01370173-.25638455.01491949-.03391433.2870907-.5648352.07595722-.22295674.02090685-.03385347.3960035-.47320292.11502503-.19620002.04706656-.04640061.50488475-.3157519.16336819-.15047829-.09682959.04685973-.62600092.27318837-.2126852.12032844.39343953-.14550896.0252802-.01333644-.0731897.02556183-.13427838.05304358-.26892327.10515102-.40402373.15606713-1.94757487.73399409-3.97338269,1.23848687-6.03458864,1.52246655-.57388324.07906594-1.21696142.67535005-1.49407768,1.14889971-.31358395.5358674-.44643885,1.3256252-.25202087,1.9263969.19576179.60492423.5706341,1.18855359,1.14889971,1.49407768.63694467.33652691,1.22025665.34930833,1.9263969.25202087,2.31380496-.31878115,4.58275826-.9170628,6.74515851-1.80194905.75501111-.30896174,1.41649503-.59050236,2.02229643-1.15785788.77712433-.7278058,1.14939912-1.67972268,1.24446573-2.72122433.11409835-1.25000371-.32807583-2.5291758-.87555851-3.63299153-1.02653863-2.06967184-2.93440924-3.56476025-5.05654228-4.38055158-2.08554829-.8017274-4.84744059-.74560096-6.69341403.61680451-1.31857823.97316578-2.21689257,2.44040916-2.08235509,4.12988801.14592292,1.83245365,1.17066479,3.24263973,2.90549024,3.87956522,1.22972505.45148245,2.79257535-.50483024,3.07529661-1.74609855.32183211-1.4129818-.42947189-2.59190903-1.74609855-3.07529661h0Z"/><path d="M22.90500728,39.1802384c5.81841141-.35992492,11.63682281-.71984983,17.45523422-1.07977475,1.34784293-.0833771,2.5-1.08933328,2.5-2.5,0-1.28882103-1.14543309-2.58379304-2.5-2.5-5.81841141.35992492-11.63682281.71984983-17.45523422,1.07977475-1.34784293.0833771-2.5,1.08933328-2.5,2.5,0,1.28882103,1.14543309,2.58379304,2.5,2.5h0Z"/><path d="M492.53726385,41.3699431c8.68734954-1.09794288,17.43433148-1.61275587,26.19049394-1.54147023,3.21817663.02619981,3.22124409-4.97377522,0-5-8.75616577-.07128567-17.50314768.44352776-26.19049394,1.54147023-1.33927612.16926321-2.5,1.02785259-2.5,2.5,0,1.21947426,1.15114907,2.67047331,2.5,2.5h0Z"/><path d="M19.36319162,108.19030085c20.83512651-.35942389,41.67025301-.71884777,62.50537952-1.07827166,5.89360152-.1016697,11.78720304-.20333941,17.68080456-.30500911,3.21391366-.05544278,3.22403086-5.05561731,0-5-20.83512651.35942389-41.67025301.71884777-62.50537952,1.07827166-5.89360152.1016697-11.78720304.20333941-17.68080456.30500911-3.21391366.05544278-3.22403086,5.05561731,0,5h0Z"/><path d="M105.79053182,99.75850186c-.01998844,2.20209082-.30872372,4.59282696.04127701,6.77016588.44390899,2.76153804,2.85320788,3.21695716,5.21114213,3.21051279,4.72125486-.01290346,9.44250972-.02580686,14.16376458-.03871022,9.52533863-.02603309,19.05067727-.05206601,28.5760159-.07809887,5.46671605-.0149406,10.9334321-.02988117,16.40014815-.04482175,3.21685852-.0087917,3.22294641-5.00880834,0-5-10.27079987.02807017-20.54159974.05614034-30.8123996.08421065-5.13539998.01403515-10.27079996.02807034-15.40619993.04210558-2.48487098.00679125-4.96974195.0135825-7.45461293.02037377-1.32526453.00362201-2.65052905.00724403-3.97579358.01086605-.66261434.00181096-1.32528101.0061521-1.98789679.00543303-.27024318.00362944-.54045811.00254317-.81064477-.0032588.04831326.00884908.09079849-.00576876.12745569-.04385352l.89687884.89687884c-.01758802.35369166-.02447199.30160948-.02065189-.15624656l.0085862-.94592615.0128793-1.41888922.03005169-3.31074152c.02921218-3.21825449-4.97076233-3.221062-5,0h0Z"/><path d="M169.33777167,96.6177761l1.97495495,10.35106969c.24560923,1.28727913,1.86206884,2.13871573,3.07529661,1.74609855,1.37378735-.44457646,2.00924605-1.6960965,1.74609855-3.07529661l-1.97495495-10.35106969c-.24560923-1.28727913-1.86206884-2.13871573-3.07529661-1.74609855-1.37378735.44457646-2.00924605,1.6960965-1.74609855,3.07529661h0Z"/><path d="M184.09419894,102.60364057c22.2379562.28592703,44.4759124.57185407,66.71386859.8577811,6.30628609.08108379,12.61257217.16216757,18.91885826.24325136,3.21851164.04138238,3.22026904-4.95859503,0-5-22.2379562-.28592703-44.4759124-.57185407-66.71386859-.8577811-6.30628609-.08108379-12.61257217-.16216757-18.91885826-.24325136-3.21851164-.04138238-3.22026904,4.95859503,0,5h0Z"/><path d="M280.21209981,101.75808844c-.19199615-.02719993-.37511151-.08818876-.5639309-.12124936-.31757925-.0556053.423985.23299648.1445053.07042427-.07014268-.04080171-.14589398-.07350817-.21656043-.11392045-.06737505-.03853001-.60912542-.395169-.29122486-.17954311.29752072.20180263.00386216-.01089573-.06751108-.07657043-.10459772-.09624649-.20596746-.19577829-.30455268-.2982004-.13934114-.14476422-.27251844-.29543101-.40205359-.44897528-.05565697-.0659729-.10967249-.13321785-.16485522-.19957668-.11984611-.14411842-.14276491-.32449066.07458263.09956031-.19136643-.3733611-.51852821-.70912903-.73945426-1.07108536-.10885169-.17833822-.21282233-.35973378-.30863382-.54544925-.02930812-.05680917-.12224811-.30249758-.15615573-.32038065.02016674.01063605.16055087.45061871.08413851.19130253-.05587238-.18961084-.11288335-.38474207-.17567024-.5718642-.08126546-.24219336.08827364-.24600282.00796461.17747143.0169815-.08954449-.00776879-.22758669-.01325759-.31999127-.02585644-.43529592-.08627654.53577593.02094551-.03076063.05876148-.31048207-.23807022.42891969-.05806879.16019196.14850992-.22171343-.13875677.1591026-.14290167.15832916.06903542.01288211.16963052-.24556467.25299887-.2496321.00548413-.00026756-.51984918.32243659-.07127821.07607307.21159062-.11620951.41792523-.23542023.63615536-.33985022.09051115-.04331243.18388372-.08160206.27375204-.12610323.32860205-.16271782-.38733181.14072456-.04201768.01735186.22072226-.07885893.43759868-.16786807.65981852-.24312907.47586341-.16116451.96023621-.29656548,1.45068528-.40550357.2291897-.0509074.45968099-.09096689.69004387-.13540102.14445897-.02786434.42373312-.14647088-.06826313.00155086.08976867-.02700776.20623403-.02414145.29949805-.03372411.42225023-.04338522.84750091-.07241913,1.2721893-.06173854.16003778.00402483.4290836.07306202.58171346.03780196-.00069494.00016054-.5508683-.10856661-.30204033-.04042065.06899199.01889468.14523139.02437785.2155785.03837904.18880898.03757867.37647279.08384679.56036495.14092954.06432295.01996676.13634528.05699427.20236618.0680088.28215253.04707263-.50877535-.26972357-.1457278-.0619826.1322784.07569158.27566645.17892363.41263255.23936716.20542219.09065339-.22903649-.16699939-.23897053-.1896686.01397633.03189361.15352564.14719439.19340607.18089569.30489636.25765537-.29138022-.47650468-.03057752-.03214503.02667748.0454535.05733628.14426465.09563004.17830908-.14536326-.37141069-.18648375-.45912317-.12336148-.26313745.01778455.05158915.03189156.10416449.04232104.15772602.11226546.30316075.00592696-.50354656-.02814971-.18398656.00319728.0538324.00307205.10765714-.00037567.16147423-.00951101.19575677.00629278.10860303.04741137-.26146122-.03220988.06261617-.03589037.17029185-.05399594.23944496-.07037168.26878032-.2158113.27528028.05826309-.05243032-.06487393.07756973-.24111993.59495465-.3289039.58117675-.02104744-.00330345.33494852-.37639412.13673849-.17550331-.10062858.10198957-.19182043.21316231-.29543732.31287754-.03242151.03120069-.27001297.2422811-.270429.24154417-.01388804-.02460073.41859361-.28965371.07315476-.06246951-.20316795.13361713-.40562415.26543286-.61695909.3860028-.4772856.27229901-.9763012.50416718-1.47420451.73563936-1.18944929.55296764-1.58115732,2.35910581-.89687884,3.42047458.78999647,1.22534555,2.14814871,1.48837529,3.42047458.89687884,2.58277485-1.20071611,5.07361625-3.06815691,5.19808647-6.18138448.11086152-2.77284904-2.15474001-4.87159744-4.75110291-5.32465783-2.78513674-.48600107-5.62549248.12458137-8.19041533,1.2348381-1.51997653.65793954-2.78234271,1.60802391-3.3821299,3.20783626-.51451577,1.3723679-.25326675,2.85692004.30013215,4.16827644.56820473,1.34644089,1.42755714,2.5414672,2.38591429,3.64030287.96384796,1.10513134,2.30850313,2.1122066,3.79538575,2.32285199.69468418.09841531,1.29463712.11767828,1.9263969-.25202087.51858402-.30346989,1.01315141-.89808409,1.14889971-1.49407768.26884528-1.18034675-.36135178-2.87912072-1.74609855-3.07529661h0Z"/><path d="M295.90981265,101.4397384h120.27272727c3.2172614,0,3.22259025-5,0-5h-120.27272727c-3.2172614,0-3.22259025,5,0,5h0Z"/><path d="M419.21667136,93.09331867c-.30863375,2.19593144-.45810535,4.36793616-.24177809,6.58136297.19629131,2.00842212.47178918,4.1407421,2.45122717,5.18165195.95923555.50442486,2.07855958.50264875,3.13521572.54356839,1.16559527.04513838,2.33119055.09027677,3.49678582.13541515,2.24793374.0870526,4.49586749.1741052,6.74380123.2611578,8.99173496.34821041,17.98346991.69642085,26.97520487,1.0446313,5.16192191.19989859,10.32384383.39979719,15.48576574.59969579,3.21780387.12461143,3.21238495-4.87559842,0-5-10.40710064-.40302137-20.81420127-.80604273-31.22130191-1.20906407-5.16192192-.19989858-10.32384385-.39979715-15.48576577-.59969571-1.24885208-.04836255-2.49770416-.09672511-3.74655624-.14508766-.66605444-.02579336-1.33210889-.05158672-1.99816333-.07738008-.33302722-.01289668-.66605444-.02579336-.99908166-.03869004-.63802482-.09786557-.53359849.04363958.313279.42451545.14168437-.12378777-.24609978-2.43318016-.25587457-2.77848906-.03381714-1.19464001.00212017-2.40962428.16863719-3.59439411.18767609-1.33531678-.32597095-2.68508622-1.74609855-3.07529661-1.17038449-.32158814-2.88617355.40048656-3.07529661,1.74609855h0Z"/><path d="M476.68253993,95.39428385v9.27272727c0,1.307694,1.14988643,2.56047175,2.5,2.5,1.35450499-.06066844,2.5-1.09845912,2.5-2.5v-9.27272727c0-1.307694-1.14988643-2.56047175-2.5-2.5-1.35450499.06066844-2.5,1.09845912-2.5,2.5h0Z"/><path d="M483.53796372,101.78282955c11.08758704-.44467996,22.18603589-.54070758,33.27965714-.28794712,3.21874882.07333696,3.21774993-4.9266858,0-5-11.09362154-.25276046-22.19207038-.15673283-33.27965714.28794712-3.20654419.12860201-3.22298592,5.12926142,0,5h0Z"/></svg>
<figcaption>
图1: 两个线程，只包含 SeqCst 的一个时序图。t ->, 点是 Fence，范围是其他访存操作。
</figcaption>
</figure>

在这个图中，并且如果 $A \rightarrow_{rf \cup fr \cup co} B$，那么在图上，A 的前边沿一定早于 B 的后边沿<sup>[4]</sup>。把某操作 $X$ 的前边沿记作 $start(X)$，后边沿记作 $end(X)$，在时间上 $A$ 时刻早于 $B$ 时刻记作 $A \prec B$。那么：

$$
M \to_{rf \cup fr \cup co} N \implies start(M) \prec end(N)
$$

这一事实将用于排序各个两侧的同步操作。

## Sketch proof

证明的思路大概是首先构造一个关系，可以包含 SeqCst 需要保证的所有序。如果这个关系不包含环，那么做传递闭包后是一个偏序，之后可以全序化。

证明大概分作两步：

第一步是根据 SeqCst 的执行时序，有一个很自然的基础序：如果两个 SeqCst 操作不互相重叠，那么在时间上完全更早发生的操作，应该在所有需要保证的序中都早于另一个操作。把这个序称作 Base wall-clock before $bwcb$，这是一个偏序，并且限制到同一个线程内是一个全序。

<figure>
<svg class="inline-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 507.49214873 120.67295622"><defs><style>.cls-1{fill:#319966;}</style></defs><path d="M44.39060769,16.86760121c.01831612,2.39700308.24411632,4.78380396.65564577,7.14554487.37011111,2.12404375.802947,4.46936069,1.78459699,6.40858703,1.13087712,2.234021,3.2974553,2.67184596,5.59620868,2.59166984,2.49481719-.08701445,4.98941147-.18098224,7.48410535-.27147286,9.72933688-.35291455,19.45867378-.70582851,29.1880107-1.05874224,5.57150059-.2020959,11.14300119-.40419172,16.71450179-.60628755,3.20801233-.11636468,3.22339567-5.11692268,0-5-17.95707908.65135966-35.92195827,1.52692424-53.88555819,1.95460085-.1172196.00279076-.62255603.06974832-.76787875.00563999-.18572709-.08193249.05585847.06634112.07680309.09396291-.14822435-.19547841-.23404742-.72871135-.2934682-.92370633-.33900682-1.11248345-.62374045-2.24192328-.85815398-3.38093255-.47263724-2.29653209-.67690801-4.61563242-.69481325-6.95886395-.0245744-3.21601439-5.02463133-3.22346514-5,0h0Z"/><path d="M109.89878108,18.37128634c-1.03128451,3.18371748-1.43214314,6.61611863-1.13397013,9.95022993.11617157,1.29900736,1.06661474,2.5642015,2.5,2.5,1.25466478-.05619659,2.62474984-1.10507208,2.5-2.5-.1372401-1.53459148-.12966177-3.07764058.03685816-4.60975581.00919655-.0866428.01904614-.17321213.02954876-.25970799.03516862-.27940424.02814408-.23063387-.02107363.1463111-.02518379-.1468121.05613941-.37385317.0799431-.51660737.06210037-.37242491.1332162-.74328349.21341405-1.11223578.16666532-.76674812.37491114-1.52267809.61667486-2.26903602.40320327-1.24474409-.46997527-2.7846365-1.74609855-3.07529661-1.37044825-.31214433-2.64358392.41334193-3.07529661,1.74609855h0Z"/><path d="M118.89231863,25.7850026c19.45059166-.52346332,38.9106795-.64325382,58.36624153-.35928521,3.21859898.04697788,3.21987364-4.95300351,0-5-19.45556197-.28396861-38.91564981-.16417811-58.36624153.35928521-3.211205.08642143-3.22399942,5.08676576,0,5h0Z"/><path d="M188.52487863,23.55979516c-.07707293-.0342412-.15037812-.07936919-.22713261-.11299686-.37501539-.16430173.22735883.09859745.22502639.190253.00068544-.02693521-.15216473-.15521727-.17268281-.17177439-.14642545-.11815841.34264127.54735148.18612641.23328872-.02844044-.05706858-.06340127-.11661302-.09684073-.17095667-.19208507-.31216422.15271216.48001825.11782718.2765627-.03134566-.18281364-.09666267-.35623136-.12259018-.54272769l.08930242.66459903c-.02492457-.24291031-.02382671-.47879825.00239722-.72155868l-.08930242.66459903c.01972507-.1375132.04393138-.27322457.08060469-.40738305.01821052-.06675021.03883784-.132745.06188195-.19798437.08903728-.23438796.04495418-.13067792-.1322493.31113011.0544322-.07724425.10544839-.18605154.15208233-.26895388.18978369-.33738323-.47888314.51619442-.06572183.10804564.06064287-.05914522.12367878-.11561899.18910772-.16942129-.34425613.2568385-.41131357.31364036-.20117232.17040557.10203269-.0534268.24032031-.11085528.32704564-.1812248-.40878603.16388143-.49258831.20017053-.25140683.1088673.07887458-.02771754.15861226-.0526781.23921302-.07488166.16288295-.04502193.32781871-.0758883.49460006-.10204446l-.66459903.08930242c.42963808-.05386757.85316021-.04884677,1.28241885.00654346l-.66459903-.08930242c.25701639.04003512.51045095.09280927.75942718.16902743.12340189.03777656.24269045.08964704.36580302.12712263-.69005776-.2100543-.29718955-.12740931-.09635125-.02474979.26021106.13300821.51102986.28427658.75244127.44885742.14171551.09661373.49673106.42170252-.03486491-.04420536.11011262.09650626.22839028.1848887.33941647.28058178.44824052.38633695.86333775.80969185,1.26489471,1.24380201.18410058.19902515.36546946.40063723.54536443.6034688.07334993.08270204.44549232.39849531.12864365.13750435-.13274233-.17812591-.14401191-.18311349-.03380875-.01496273-.13957196-.38902145-.17380484-.45763715-.10269864-.20584707l-.08930242-.66459903c.01737787.09121534.02189121.18304508.01354003.27548924l.08930242-.66459903c-.03841705.24544737-.19992487.47002468.08155191-.09257384-.16044204.32068171.14338045-.13758171.1464127-.16773555-.01510958.15025559-.45632548.45785531-.56439175.55475446-.18478501.16569009-.37659449.32183562-.56811247.47948844-.23682356.19494725.45197743-.32979349.09188891-.07564314-.12159154.08581927-.24188404.17282797-.36520892.2561997-.41055798.27755085-.8380474.53083031-1.27871348.75755997-.13222258.0680306-.26565241.1337918-.40015272.19720048-.08556497.04033866-.50070571.21431643-.10867439.05597204.40715784-.1644541-.06167062.0225787-.11426305.04290857-.13873563.05362897-.27871267.10375264-.41901444.15311126-1.23067107.43295414-2.18198389,1.72836575-1.74609855,3.07529661.39337569,1.21557166,1.75448228,2.21076539,3.07529661,1.74609855,2.09577076-.73729906,4.03806228-1.85370011,5.6417614-3.40481807,1.31943498-1.2761741,1.84208265-3.00961418.99821117-4.71590796-.45820366-.92648001-1.36922023-1.77793474-2.10240072-2.50491401-1.65207571-1.63810252-3.62998982-2.82891383-5.99191953-2.97407421-1.15236012-.07082219-2.33183691.21253871-3.34847378.75046647-1.13991682.60315823-1.91043628,1.59524801-2.37936446,2.76966505-.85043743,2.12989591-.04435174,5.15261682,2.16692582,6.13502123.63477034.28200946,1.22925555.4439989,1.9263969.25202087.57989764-.15969159,1.20833377-.60807206,1.49407768-1.14889971.57467963-1.08769644.37908814-2.85360066-.89687884-3.42047458h0Z"/><path d="M202.89109339,29.61772203c18.41941386-.75837838,36.85462841-1.11827812,55.28964883-1.06862079,5.20804452.0140286,10.41592695.06146098,15.62340385.13926611,3.21861401.04808945,3.21979278-4.95189294,0-5-18.4329622-.27540766-36.87127689-.15205946-55.29866441.38070007-5.20588816.15050894-10.4107389.33440593-15.61438827.54865461-3.20611905.13200482-3.22285512,5.13269389,0,5h0Z"/><path d="M285.38071908,22.90331278c-1.25569175,1.76821072-2.31523615,3.94783201-2.07768435,6.16969264.28931525,2.70601258,2.43790926,4.3177948,5.02077423,4.63214737,2.70515559.32923619,5.51379312.19219039,8.23709964.24980923,2.74758958.05813261,5.49517916.11626525,8.24276874.1743979,11.15687875.23605379,22.31375749.47210786,33.47063623.70816204,6.32778191.13388147,12.65556383.26776297,18.98334574.40164447,3.2187534.06810152,3.21820601-4.93191007,0-5-20.23225023-.42806849-40.46450046-.85613698-60.69675072-1.28420441-1.41542494-.0299471-2.83084989-.0598942-4.24627483-.0898413-1.15805023-.02450164-2.4237871.08867624-3.56431217-.11703431-.31239174-.05634447-.57710479-.2337432-.46009013-.03578419-.05319333-.08998957-.03032556-.38615214.01325946-.62052065.18122009-.97446971.83461163-1.87634765,1.39458157-2.66487306.78220214-1.10146317.19550657-2.78153988-.89687884-3.42047458-1.25357655-.73321517-2.63645764-.20713985-3.42047458.89687884h0Z"/><path d="M356.36179182,20.13629626c-.28565251,2.5402118-.26793812,5.10182694.05281688,7.63784182.08705442.68828642.22137623,1.25691014.73223305,1.76776695.4336057.4336057,1.14501564.76012615,1.76776695.73223305.64655933-.02895947,1.31713952-.24134366,1.76776695-.73223305.41566084-.45279866.81321726-1.12747398.73223305-1.76776695-.32075544-2.5360184-.33846899-5.09763354-.05281688-7.63784182.06687356-.59468408-.32732545-1.36285936-.73223305-1.76776695-.4336057-.4336057-1.14501564-.76012615-1.76776695-.73223305-.64655933.02895947-1.31713952.24134366-1.76776695.73223305-.47609294.51863014-.65396592,1.07176366-.73223305,1.76776695h0Z"/><path d="M368.16485655,31.13273132c20.38371814-.31738413,40.76743628-.63476826,61.15115441-.95215239,5.800245-.09031256,11.60049-.18062511,17.400735-.27093767,3.21432375-.05004854,3.2239749-5.05019881,0-5-20.38371814.31738413-40.76743628.63476826-61.15115441.95215239-5.800245.09031256-11.60049.18062511-17.400735.27093767-3.21432375.05004854-3.2239749,5.05019881,0,5h0Z"/><path d="M458.36800491,28.49755893c.80573722.29581914.43250996.21458361.30514849.11845908-.00571326-.00431201.51047769.45243995.25828748.19986334-.1772498-.17752138.02598836-.11543785.18843098.26717666-.0097624-.02299418-.11944414-.17721247-.10946127-.1809113.01926462-.00713789.26073332.71223026.08248757.14309769-.03300526-.10538467-.06681483-.39140533-.00153613.06135655.0676718.46936001.03424839.11792649.02862795.00039777-.01900572-.39742693-.12165398.69967996-.00138329.11752935.07660545-.37079616-.31820946.53801631-.05171828.1447908.15491995-.22859473-.37191827.40502359-.15809369.19053055.06133025-.06152199.13184884-.12479455.18568674-.1922329.14482933-.18141589-.24309208.17507657-.24909773.17798857.11567769-.05608952.22664291-.15256136.34064455-.21513513.0473565-.02599326.20369557-.1255126.2431004-.12025966.04900142.00653224-.5504091.18951161-.27869648.12733732.1792837-.04102436.3514722-.10745912.53283565-.14487727.10503182-.02166973.42891116-.06849809.00939484-.01141174-.40437812.05502639-.14548629.01801899-.05764452.01415863.22501764-.00988878.44792267-.01946505.6732703-.00898775.11075791.00514957.67545461.06891335.19598021.00560351-.4787462-.06321369.08070101.02455902.18921962.04933881.17223721.03932968.3430028.0860257.51125235.13991521.0841962.02696763.16675309.05926601.25097621.08595048.40261153.12755968-.43931421-.20749075-.16692857-.07668535.30097916.14453662.59528758.29353178.87676995.47414979.1454402.09332421.30952759.1875208.43700238.30454026-.01769055-.01623959-.48373568-.41193708-.19440296-.14072676.08089778.07583074.16696434.14622008.24785302.22223669.23347365.2194111.49978683.46360262.67421565.73395435-.01294092-.02005747-.36277611-.52179786-.15383367-.18598587.04660539.07490412.09945086.14650241.14680558.22096298.09480869.1490772.18329202.30240331.26503085.45903568.04092439.07842152.07697547.15901523.11751774.23752679.19345561.37463377-.11091258-.23432278-.09548635-.23166515.04481656.00772098.15639843.45601916.17000351.50319978.02762586.09580285.16976149.44467196.12455465.53586706-.02298826.04637387-.0320665-.59712802-.04798061-.30973521-.0048273.08717607-.03031564.26968403-.00033508.35355868-.14348489-.40141826.12553338-.5105954.01370173-.25638455.01491949-.03391433.2870907-.5648352.07595722-.22295674.02090685-.03385347.3960035-.47320292.11502503-.19620002.04706656-.04640061.50488475-.3157519.16336819-.15047829-.09682959.04685973-.62600092.27318837-.2126852.12032844.39343953-.14550896.0252802-.01333644-.0731897.02556183-.13427838.05304358-.26892327.10515102-.40402373.15606713-1.94757487.73399409-3.97338269,1.23848687-6.03458864,1.52246655-.57388324.07906594-1.21696142.67535005-1.49407768,1.14889971-.31358395.5358674-.44643885,1.3256252-.25202087,1.9263969.19576179.60492423.5706341,1.18855359,1.14889971,1.49407768.63694467.33652691,1.22025665.34930833,1.9263969.25202087,2.31380496-.31878115,4.58275826-.9170628,6.74515851-1.80194905.75501111-.30896174,1.41649503-.59050236,2.02229643-1.15785788.77712433-.7278058,1.14939912-1.67972268,1.24446573-2.72122433.11409835-1.25000371-.32807583-2.5291758-.87555851-3.63299153-1.02653863-2.06967184-2.93440924-3.56476025-5.05654228-4.38055158-2.08554829-.8017274-4.84744059-.74560096-6.69341403.61680451-1.31857823.97316578-2.21689257,2.44040916-2.08235509,4.12988801.14592292,1.83245365,1.17066479,3.24263973,2.90549024,3.87956522,1.22972505.45148245,2.79257535-.50483024,3.07529661-1.74609855.32183211-1.4129818-.42947189-2.59190903-1.74609855-3.07529661h0Z"/><path d="M9.25461532,31.83524652c5.81841141-.35992492,11.63682281-.71984983,17.45523422-1.07977475,1.34784293-.0833771,2.5-1.08933328,2.5-2.5,0-1.28882103-1.14543309-2.58379304-2.5-2.5-5.81841141.35992492-11.63682281.71984983-17.45523422,1.07977475-1.34784293.0833771-2.5,1.08933328-2.5,2.5,0,1.28882103,1.14543309,2.58379304,2.5,2.5h0Z"/><path d="M478.88687189,34.02495122c8.68734954-1.09794288,17.43433148-1.61275587,26.19049394-1.54147023,3.21817663.02619981,3.22124409-4.97377522,0-5-8.75616577-.07128567-17.50314768.44352776-26.19049394,1.54147023-1.33927612.16926321-2.5,1.02785259-2.5,2.5,0,1.21947426,1.15114907,2.67047331,2.5,2.5h0Z"/><path d="M5.71279965,100.84530897c20.83512651-.35942389,41.67025301-.71884777,62.50537952-1.07827166,5.89360152-.1016697,11.78720304-.20333941,17.68080456-.30500911,3.21391366-.05544278,3.22403086-5.05561731,0-5-20.83512651.35942389-41.67025301.71884777-62.50537952,1.07827166-5.89360152.1016697-11.78720304.20333941-17.68080456.30500911-3.21391366.05544278-3.22403086,5.05561731,0,5h0Z"/><path d="M92.14013986,92.41350998c-.01998844,2.20209082-.30872372,4.59282696.04127701,6.77016588.44390899,2.76153804,2.85320788,3.21695716,5.21114213,3.21051279,4.72125486-.01290346,9.44250972-.02580686,14.16376458-.03871022,9.52533863-.02603309,19.05067727-.05206601,28.5760159-.07809887,5.46671605-.0149406,10.9334321-.02988117,16.40014815-.04482175,3.21685852-.0087917,3.22294641-5.00880834,0-5-10.27079987.02807017-20.54159974.05614034-30.8123996.08421065-5.13539998.01403515-10.27079996.02807034-15.40619993.04210558-2.48487098.00679125-4.96974195.0135825-7.45461293.02037377-1.32526453.00362201-2.65052905.00724403-3.97579358.01086605-.66261434.00181096-1.32528101.0061521-1.98789679.00543303-.27024318.00362944-.54045811.00254317-.81064477-.0032588.04831326.00884908.09079849-.00576876.12745569-.04385352l.89687884.89687884c-.01758802.35369166-.02447199.30160948-.02065189-.15624656l.0085862-.94592615.0128793-1.41888922.03005169-3.31074152c.02921218-3.21825449-4.97076233-3.221062-5,0h0Z"/><path d="M155.68737971,89.27278421c.65831832,3.45035656,1.31663664,6.90071313,1.97495495,10.35106969.24560923,1.28727913,1.86206884,2.13871573,3.07529661,1.74609855,1.37378735-.44457646,2.00924605-1.6960965,1.74609855-3.07529661-.65831832-3.45035656-1.31663664-6.90071313-1.97495495-10.35106969-.24560923-1.28727913-1.86206884-2.13871573-3.07529661-1.74609855-1.37378735.44457646-2.00924605,1.6960965-1.74609855,3.07529661h0Z"/><path d="M170.44380698,95.25864868c22.2379562.28592703,44.4759124.57185407,66.71386859.8577811,6.30628609.08108379,12.61257217.16216757,18.91885826.24325136,3.21851164.04138238,3.22026904-4.95859503,0-5-22.2379562-.28592703-44.4759124-.57185407-66.71386859-.8577811-6.30628609-.08108379-12.61257217-.16216757-18.91885826-.24325136-3.21851164-.04138238-3.22026904,4.95859503,0,5h0Z"/><path d="M266.56170785,94.41309655c-.19199615-.02719993-.37511151-.08818876-.5639309-.12124936-.31757925-.0556053.423985.23299648.1445053.07042427-.07014268-.04080171-.14589398-.07350817-.21656043-.11392045-.06737505-.03853001-.60912542-.395169-.29122486-.17954311.29752072.20180263.00386216-.01089573-.06751108-.07657043-.10459772-.09624649-.20596746-.19577829-.30455268-.2982004-.13934114-.14476422-.27251844-.29543101-.40205359-.44897528-.05565697-.0659729-.10967249-.13321785-.16485522-.19957668-.11984611-.14411842-.14276491-.32449066.07458263.09956031-.19136643-.3733611-.51852821-.70912903-.73945426-1.07108536-.10885169-.17833822-.21282233-.35973378-.30863382-.54544925-.02930812-.05680917-.12224811-.30249758-.15615573-.32038065.02016674.01063605.16055087.45061871.08413851.19130253-.05587238-.18961084-.11288335-.38474207-.17567024-.5718642-.08126546-.24219336.08827364-.24600282.00796461.17747143.0169815-.08954449-.00776879-.22758669-.01325759-.31999127-.02585644-.43529592-.08627654.53577593.02094551-.03076063.05876148-.31048207-.23807022.42891969-.05806879.16019196.14850992-.22171343-.13875677.1591026-.14290167.15832916.06903542.01288211.16963052-.24556467.25299887-.2496321.00548413-.00026756-.51984918.32243659-.07127821.07607307.21159062-.11620951.41792523-.23542023.63615536-.33985022.09051115-.04331243.18388372-.08160206.27375204-.12610323.32860205-.16271782-.38733181.14072456-.04201768.01735186.22072226-.07885893.43759868-.16786807.65981852-.24312907.47586341-.16116451.96023621-.29656548,1.45068528-.40550357.2291897-.0509074.45968099-.09096689.69004387-.13540102.14445897-.02786434.42373312-.14647088-.06826313.00155086.08976867-.02700776.20623403-.02414145.29949805-.03372411.42225023-.04338522.84750091-.07241913,1.2721893-.06173854.16003778.00402483.4290836.07306202.58171346.03780196-.00069494.00016054-.5508683-.10856661-.30204033-.04042065.06899199.01889468.14523139.02437785.2155785.03837904.18880898.03757867.37647279.08384679.56036495.14092954.06432295.01996676.13634528.05699427.20236618.0680088.28215253.04707263-.50877535-.26972357-.1457278-.0619826.1322784.07569158.27566645.17892363.41263255.23936716.20542219.09065339-.22903649-.16699939-.23897053-.1896686.01397633.03189361.15352564.14719439.19340607.18089569.30489636.25765537-.29138022-.47650468-.03057752-.03214503.02667748.0454535.05733628.14426465.09563004.17830908-.14536326-.37141069-.18648375-.45912317-.12336148-.26313745.01778455.05158915.03189156.10416449.04232104.15772602.11226546.30316075.00592696-.50354656-.02814971-.18398656.00319728.0538324.00307205.10765714-.00037567.16147423-.00951101.19575677.00629278.10860303.04741137-.26146122-.03220988.06261617-.03589037.17029185-.05399594.23944496-.07037168.26878032-.2158113.27528028.05826309-.05243032-.06487393.07756973-.24111993.59495465-.3289039.58117675-.02104744-.00330345.33494852-.37639412.13673849-.17550331-.10062858.10198957-.19182043.21316231-.29543732.31287754-.03242151.03120069-.27001297.2422811-.270429.24154417-.01388804-.02460073.41859361-.28965371.07315476-.06246951-.20316795.13361713-.40562415.26543286-.61695909.3860028-.4772856.27229901-.9763012.50416718-1.47420451.73563936-1.18944929.55296764-1.58115732,2.35910581-.89687884,3.42047458.78999647,1.22534555,2.14814871,1.48837529,3.42047458.89687884,2.58277485-1.20071611,5.07361625-3.06815691,5.19808647-6.18138448.11086152-2.77284904-2.15474001-4.87159744-4.75110291-5.32465783-2.78513674-.48600107-5.62549248.12458137-8.19041533,1.2348381-1.51997653.65793954-2.78234271,1.60802391-3.3821299,3.20783626-.51451577,1.3723679-.25326675,2.85692004.30013215,4.16827644.56820473,1.34644089,1.42755714,2.5414672,2.38591429,3.64030287.96384796,1.10513134,2.30850313,2.1122066,3.79538575,2.32285199.69468418.09841531,1.29463712.11767828,1.9263969-.25202087.51858402-.30346989,1.01315141-.89808409,1.14889971-1.49407768.26884528-1.18034675-.36135178-2.87912072-1.74609855-3.07529661h0Z"/><path d="M282.25942069,94.09474651h120.27272727c3.2172614,0,3.22259025-5,0-5h-120.27272727c-3.2172614,0-3.22259025,5,0,5h0Z"/><path d="M405.56627939,85.74832678c-.30863375,2.19593144-.45810535,4.36793616-.24177809,6.58136297.19629131,2.00842212.47178918,4.1407421,2.45122717,5.18165195.95923555.50442486,2.07855958.50264875,3.13521572.54356839,1.16559527.04513838,2.33119055.09027677,3.49678582.13541515,2.24793374.0870526,4.49586749.1741052,6.74380123.2611578,8.99173496.34821041,17.98346991.69642085,26.97520487,1.0446313,5.16192191.19989859,10.32384383.39979719,15.48576574.59969579,3.21780387.12461143,3.21238495-4.87559842,0-5-10.40710064-.40302137-20.81420127-.80604273-31.22130191-1.20906407-5.16192192-.19989858-10.32384385-.39979715-15.48576577-.59969571-1.24885208-.04836255-2.49770416-.09672511-3.74655624-.14508766-.66605444-.02579336-1.33210889-.05158672-1.99816333-.07738008-.33302722-.01289668-.66605444-.02579336-.99908166-.03869004-.63802482-.09786557-.53359849.04363958.313279.42451545.14168437-.12378777-.24609978-2.43318016-.25587457-2.77848906-.03381714-1.19464001.00212017-2.40962428.16863719-3.59439411.18767609-1.33531678-.32597095-2.68508622-1.74609855-3.07529661-1.17038449-.32158814-2.88617355.40048656-3.07529661,1.74609855h0Z"/><path d="M463.03214796,88.04929197v9.27272727c0,1.307694,1.14988643,2.56047175,2.5,2.5,1.35450499-.06066844,2.5-1.09845912,2.5-2.5v-9.27272727c0-1.307694-1.14988643-2.56047175-2.5-2.5-1.35450499.06066844-2.5,1.09845912-2.5,2.5h0Z"/><path d="M469.88757175,94.43783767c11.08758704-.44467996,22.18603589-.54070758,33.27965714-.28794712,3.21874882.07333696,3.21774993-4.9266858,0-5-11.09362154-.25276046-22.19207038-.15673283-33.27965714.28794712-3.20654419.12860201-3.22298592,5.12926142,0,5h0Z"/><path class="cls-1" d="M176.84592572,37.10557417c-6.02703392,11.89769586-11.57032165,24.03075489-16.65573509,36.35998377-.51506454,1.24873792.55752711,2.74871122,1.74609855,3.07529661,1.43584806.39452993,2.55830114-.49267921,3.07529661-1.74609855,4.91998097-11.92814945,10.3210246-23.65552587,16.15169335-35.16558609,1.45077884-2.86391708-2.86135988-5.39780694-4.31735343-2.52359574h0Z"/><path class="cls-1" d="M178.53375923,33.15545396c-2.92086284,1.00813302-5.74062537,2.32829836-8.35329395,3.97999115-1.10448225.69823834-1.64612922,2.25832936-.89687884,3.42047458.71285336,1.10569064,2.23798701,1.64443106,3.42047458.89687884,1.71465957-1.08398396,3.51229184-2.02575397,5.37924125-2.81917157l-.59719884.25202087c.78237251-.3289405,1.57458394-.63189601,2.37685386-.90879871.61920597-.21371835,1.15595203-.57109426,1.49407768-1.14889971.31358395-.5358674.44643885-1.3256252.25202087-1.9263969-.39540351-1.22183782-1.75171933-2.20292999-3.07529661-1.74609855h0Z"/><path class="cls-1" d="M175.53998188,39.34504367c.24422185.17732039.48590342.35793133.72515484.54190063l-.50596908-.39090976c1.83117959,1.41809027,3.4911153,3.04420174,4.94587576,4.84641796.37721231.4673059,1.19471553.73223305,1.76776695.73223305.61316822,0,1.34560469-.27235209,1.76776695-.73223305.43736004-.47643661.76205534-1.1019439.73223305-1.76776695l-.08930242-.66459903c-.11877984-.423512-.33309005-.79123464-.64293063-1.10316792-1.78520971-2.21159014-3.87971303-4.11125401-6.17699968-5.77922836-.4947973-.35925391-1.36157-.40756229-1.9263969-.25202087-.57989764.15969159-1.20833377.60807206-1.49407768,1.14889971-.30654619.58020013-.46020846,1.28307569-.25202087,1.9263969l.25202087.59719884c.2222534.37566583.52121301.67462544.89687884.89687884h0Z"/><path class="cls-1" d="M120.04755435,13.13313673c19.01740746-5.69723091,39.26522843-7.117893,58.87720941-3.95610538,1.33140368.2146451,2.69016716-.34446247,3.07529661-1.74609855.3274475-1.19170897-.4054178-2.85915589-1.74609855-3.07529661-15.96568875-2.57394279-32.24149908-2.37386763-48.13067558.66509231-4.52246248.86496505-8.99444289,1.96972028-13.40492995,3.29101306-3.07473691.92112903-1.76498503,5.74834989,1.32919806,4.82139517h0Z"/><path class="cls-1" d="M176.61561124,4.25372859c2.70935408,2.57208806,5.22822239,5.33482701,7.53969679,8.2696712l.50596908-3.92644367c-.58161352.42544785-1.18537593.81731498-1.81692836,1.16483021-.31540961.17355589-.63668648.33632322-.96288593.48860482-.14760641.06890796-.2954898.142846-.44776097.20122844.58374776-.22381532-.04859778.01026962-.13137139.04136555-.67390289.25316807-1.36507358.46144035-2.06651251.62331308-.31881904.07357463-.63996399.13772186-.96268919.19167133-.14137497.02363343-.70375558.19596538-.11284779.02158341-.17907468.05284648-.4022605.04208181-.58621418.05797852-1.29946215.11229556-2.56407682,1.06939835-2.5,2.5.0563464,1.25800957,1.10470687,2.62057698,2.5,2.5,3.45109817-.29823338,6.80045892-1.41746479,9.61080606-3.47322193.65631618-.48009253,1.08272751-1.00161642,1.19355092-1.8263772.11379104-.8468462-.17489077-1.44911035-.68758184-2.10006647-2.31147542-2.93484547-4.8303439-5.69758426-7.53969679-8.2696712-.94900381-.90092373-2.60595407-1.01263448-3.53553391,0-.89652627.9766277-1.0131428,2.57372071,0,3.53553391h0Z"/><path class="cls-1" d="M367.83396119,17.26288889c3.01842312-3.68515289,7.23220657-5.74158499,11.73879355-7.03599492,5.19719403-1.49277039,10.64432363-2.20670469,16.00418889-2.819889,12.4136484-1.42015781,24.97372436-1.58914063,37.42014691-.48802374,4.85045491.42911269,10.29584754,1.1397386,13.593765,5.11607659.86253185,1.03996483,2.6433047.8922292,3.53553391,0,1.02906277-1.02906277.86466507-2.49299703,0-3.53553391-3.4674273-4.180718-8.90824978-5.58731478-14.06883855-6.25603119-6.18408929-.80134305-12.48972924-1.01863654-18.72022691-1.03978995-6.69695961-.02273711-13.39519785.31642622-20.0555549,1.01608218-5.92804814.62272851-11.95409072,1.34487172-17.73764428,2.83175531-5.71839819,1.47013291-11.42712372,4.01376845-15.24569753,8.67581473-.8548706,1.04370021-1.02125971,2.5142742,0,3.53553391.88211895.88211895,2.6757362,1.04971566,3.53553391,0h0Z"/><path class="cls-1" d="M446.15046635,7.04999412c.91172119,1.59789802,1.79825813,3.20996542,2.65587789,4.83756217.41966883.79645043.83269568,1.59639872,1.23894704,2.39977648.21183355.41890903.41295268.84422973.63035973,1.26022643.11830196.25354672.13625006.28183135.05384431.08485389-.07044973-.18537755-.06806941-.16719023.00714095.05456197-.11993588-.90596695.15146247-1.5138274.81419503-1.82358134.40107846-.19785008.45688747-.255223.16742704-.17211874l.32337088-.04873383c-.15922415.01263115-.31848039.0248438-.47776873.03663793-.2389315.01769122-.47793401.03444066-.71699742.05024834-.43828509.02898089-.87678018.05471721-1.31543747.07736589-.91719273.04735635-1.83508995.08094726-2.75329545.10060859-1.91650559.04103769-3.8334971.01922715-5.74882013-.05795974-1.30829653-.05272392-2.55878381,1.18757202-2.5,2.5.06268856,1.39960674,1.09838191,2.44351525,2.5,2.5,2.23459062.09005327,4.47146108.10375779,6.70681927.03241664,1.03767559-.03311728,2.07479203-.08393141,3.11073378-.15243137,1.36790408-.09045042,2.86089772-.08380129,3.90397701-1.12153242,1.28739054-1.28078972,1.01070791-3.00617909.29415754-4.47864547-.4623354-.95007044-.94536517-1.8907688-1.43167925-2.82873588-1.00896053-1.94600936-2.05919179-3.87023553-3.1454986-5.77411527-.64844271-1.1364717-2.29380368-1.62325846-3.42047458-.89687884-1.14781594.7400121-1.59064481,2.20456859-.89687884,3.42047458h0Z"/><path class="cls-1" d="M2.5,7.94737669c9.72256748-1.17986515,19.8490597,1.35309878,27.63025282,7.39316987,1.06546371.82705524,2.49680808,1.03872582,3.53553391,0,.86209969-.86209969,1.07268684-2.70287179,0-3.53553391C24.85807421,4.96811645,13.62465778,1.59736333,2.5,2.94737669c-1.34013459.16262969-2.5,1.03260113-2.5,2.5,0,1.22484458,1.15054569,2.66376066,2.5,2.5h0Z"/><path class="cls-1" d="M31.67651015,5.87556767l3.23044077,4.72780785c.53832689.78785103,1.08430945,1.57104389,1.61522038,2.36390393.03169418.04733195.339601.45417863.31806655.50995949-.07574581-.11681859-.11138202-.24310231-.10690863-.37885114-.02257928-.15861556-.01030339-.31603649.03682765-.47226278.04260484-.18653722.12772849-.34812004.25537095-.48474846.14776261-.17430604.15153003-.18994198.01130226-.04690784.3032156-.22125449.37262824-.28297079.20823793-.18514888-.16555998.08982608-.0809572.05997787.25380835-.08954461-.13774123-.04721718-.73222276.20760781-.90884538.23811029-.20814543.03594643-.41829528.06175938-.62742737.09102106-.10191528.01425995-.79365664.10676165-.29191996.04073249-.95707667.12595246-1.9155071.24141477-2.87523253.34530719-1.91956845.20779757-3.84371956.36879751-5.77075284.48848761-1.30272153.08091342-2.56306798,1.09192224-2.5,2.5.05755762,1.28505155,1.1021209,2.58682376,2.5,2.5,2.2482274-.1396398,4.49248148-.33623552,6.73005125-.59611777,1.26065161-.14641822,2.51989873-.3095204,3.77602118-.49068835,1.08014181-.15578662,2.08482216-.50328039,2.92978261-1.21818274,1.07662342-.91090727,1.5199098-2.45398409,1.10509485-3.80548223-.34613154-1.12772246-1.14688338-2.08506878-1.80293702-3.04521502-1.25628252-1.83859194-2.51256504-3.67718388-3.76884756-5.51577583-.73639787-1.07773145-2.23041818-1.66412393-3.42047458-.89687884-1.0724989.69145421-1.68593496,2.26567683-.89687884,3.42047458h0Z"/><path class="cls-1" d="M18.13115096,111.93484173c17.93173164,8.30654265,38.20684645,10.744127,57.62092077,7.08442672,5.42977261-1.02355332,10.75158343-2.55082959,15.90250276-4.54889712,1.25803463-.48799796,2.12981794-1.67901311,1.74609855-3.07529661-.33017284-1.20143757-1.80959083-2.23707219-3.07529661-1.74609855-17.42496475,6.75923149-36.79694297,7.88125407-54.89591774,3.21626534-5.06904446-1.30654004-10.02442181-3.04726923-14.77471199-5.2477532-1.22433603-.567151-2.69364743-.34577613-3.42047458.89687884-.63168368,1.07998835-.33391533,2.85033197.89687884,3.42047458h0Z"/><path class="cls-1" d="M83.89730522,109.71979716l3.95097962-.04725199c.35916259-.00429543.71835945-.01067638,1.0775399-.01288691.11711771-.00072078.23414181-.0021928.35121482.00253116.42047281.01696629-.00991302-.0149765-.18065348-.03029333.25013023.07701293.17775835.04458949-.21711564-.0972703l-.32091425-.24920178c.30673331.25445111-.30944828-.49491342-.12709709-.14306624-.05517846-.106467-.22098924-.60881204-.12077311-.21330616.0636923.2513635-.05280165-.71982158-.02709392-.1802211.0545994,1.14603094-.22417451,2.34697715-.36526235,3.48119945-.16395679,1.31806855-.32791338,2.63613713-.49186998,3.9542057-.07335643.58972198.33222419,1.3677581.73223305,1.76776695.4336057.4336057,1.14501564.76012615,1.76776695.73223305.64655933-.02895947,1.31713952-.24134366,1.76776695-.73223305.47869321-.52146274.64553787-1.07081309.73223305-1.76776695.182174-1.46452064.36434799-2.92904129.54652225-4.3935619.17678016-1.42115677.50968091-2.88768963.12961126-4.30524159-.26404007-.98479453-.93326485-1.8394107-1.82094987-2.33355842-.86327528-.48055955-1.84604335-.49830978-2.80459359-.48684594l-4.57954456.05476935c-1.30711599.01563254-2.5609728,1.13869995-2.5,2.5.06006858,1.34111213,1.09883162,2.51675736,2.5,2.5h0Z"/><path class="cls-1" d="M274.60047168,80.00096956c1.92552564-12.67811297,5.03840262-25.15009806,9.29623546-37.24609287.47311579-1.34406548-.54823835-2.64329644-1.74609855-3.07529661-2.79882312-1.00937661-6.05507867-.15657894-8.0695523,2.00813506-2.19011032,2.35344976,1.33777102,5.89720696,3.53553391,3.53553391.91002647-.97789666,1.97976064-1.16408327,3.20482033-.72227379l-1.74609855-3.07529661c-4.2578324,12.09599358-7.37070963,24.56797861-9.29623546,37.24609287-.20248923,1.33323662.33611516,2.68787355,1.74609855,3.07529661,1.18208789.3248039,2.8713306-.40313842,3.07529661-1.74609855h0Z"/><path class="cls-1" d="M281.80102598,45.93850386c1.08716281,1.36661658,2.17432562,2.73323317,3.26148843,4.09984975.22644293.24379107.49463243.4160978.8045685.5169202.29793293.15652643.61899908.22829738.96319845.21531285.61316822,0,1.34560469-.27235209,1.76776695-.73223305.43736004-.47643661.76205534-1.1019439.73223305-1.76776695l-.08930242-.66459903c-.11877984-.423512-.33309005-.79123464-.64293063-1.10316792-1.08716281-1.36661658-2.17432562-2.73323317-3.26148843-4.09984975-.22644293-.24379107-.49463243-.4160978-.8045685-.5169202-.29793293-.15652643-.61899908-.22829738-.96319845-.21531285-.61316822,0-1.34560469.27235209-1.76776695.73223305-.43736004.47643661-.76205534,1.1019439-.73223305,1.76776695l.08930242.66459903c.11877984.423512.33309005.79123464.64293063,1.10316792h0Z"/><path class="cls-1" d="M193.62649735,37.36472305c15.61498341,5.6386394,30.41179756,13.48388317,43.88511699,23.18216691,3.8282409,2.75562133,7.53276893,5.67199584,11.12558368,8.72790793,1.02782512.8742291,2.52668663,1.00884728,3.53553391,0,.89631605-.89631605,1.03309573-2.65682183,0-3.53553391-13.14343824-11.17931056-27.79172203-20.54401878-43.52405534-27.64236208-4.4907899-2.02622-9.05918385-3.88028937-13.69298117-5.55357403-1.27002261-.45861077-2.73742355.51644691-3.07529661,1.74609855-.38161263,1.38883698.47146962,2.61502248,1.74609855,3.07529661h0Z"/><path class="cls-1" d="M246.72692565,57.70385537l-.03461186,4.73921487c-.00503767.68978043-.01775689,1.37888953-.03260512,2.06806276-.01716116.19658612-.00426145.10798718.03869914-.26579681l-.03320004.15467405c-.23577925.49909133.31439196-.48910047.02074445-.03353081.16191144-.25119212.37999124-.34542788.58920453-.52844793.1971178-.07509033.18865145-.08134339-.02539905-.01875917.34771975-.03828424.42418866-.05078386.22940673-.03749888-3.10997199-.09812803-6.24375307.00957995-9.35611832.00928781-1.30769782-.00012274-2.56046782,1.14997424-2.5,2.5.06067315,1.35461011,1.09845683,2.49986845,2.5,2.5,1.81219144.0001701,3.62438288.0003402,5.43657432.00051027.86985191.00008164,1.73970383.00016327,2.60955574.0002449,1.03057398.00009671,2.0688534.03269574,3.03631059-.37557598,1.1468798-.48398896,1.97530058-1.47656531,2.28111617-2.68703215.21728947-.86006636.1945725-1.76102447.20099105-2.63988149l.03933166-5.38547144c.00955239-1.30795729-1.15671914-2.56016571-2.5-2.5-1.36268378.06103477-2.48976305,1.09831019-2.5,2.5h0Z"/><path class="cls-1" d="M365.55464125,45.21477472c10.15036804,11.40986687,19.48926717,23.50680195,27.95843859,36.21459953,1.77605691,2.66493268,6.10865324.16420857,4.31735343-2.52359574-8.70135709-13.05618687-18.31161685-25.50386834-28.74025811-37.2265377-2.14312926-2.40905743-5.66895006,1.13739482-3.53553391,3.53553391h0Z"/><path class="cls-1" d="M384.15050158,79.87512115c1.93097295,1.43162642,3.92447649,2.77619276,5.98252659,4.01860229,1.06983226.64583938,2.15586232,1.26502434,3.25695372,1.85600689,1.22587048.65795451,2.47773578,1.33632875,3.89852918,1.40386576,2.41423363.11475991,4.18300921-1.6723612,4.68899762-3.91322848.16162232-.71577561.21660026-1.45072029.35448528-2.17087449.02610677-.13635202.16184945-.99013595.26272721-.99787942-.15224754.33944588-.16961266.38835242-.05209536.14671963l.0799686-.14038425c.14830556-.2217954.11351628-.18193051-.10436784.11959468.07286704-.08048467.15108222-.15538692.23464554-.22470675.97896238-.87308058.95614595-2.6578095,0-3.53553391-1.04495057-.95924541-2.49130606-.93128712-3.53553391,0-1.26164881,1.12519245-1.6410219,2.76271481-1.87220983,4.3600034-.04588566.31702627-.09043699.63464694-.15429395.94867824-.02884614.14185755-.28453382.77239121-.23726529.86360426-.11732126-.22639223.28651554-.44325953-.0185002-.06025611l.21385789-.27515189c-.18588629.1815035-.12673454.14799894.17745523-.10051368-.38050723.23114719.48266034-.07562453.05722082-.00134374-.27170224.0474386.29162977.13723045.05731044-.02013561-.06519598-.04378484-.568272-.19622157-.28316311-.07629398-.25024011-.10526047-.49503871-.24648947-.73496606-.37262735-.46796903-.24602706-.93278694-.49812976-1.39514074-.75453921-.96679156-.53615758-1.9215745-1.09385219-2.86364145-1.67235142-1.88460682-1.15728888-3.71347908-2.40156354-5.48990465-3.71860829-1.05449411-.78180361-2.83665847-.20811023-3.42047458.89687884-.69064013,1.30717494-.22868365,2.58598076.89687884,3.42047458h0Z"/><path class="cls-1" d="M475.23144127,18.28608192c6.8076412-7.59088341,17.86526083-7.08949954,27.16821716-6.64123104,3.21647269.15498766,3.20843682-4.84539956,0-5-10.66368387-.51383597-22.96187272-.52691058-30.70375107,8.10569714-2.14294582,2.38949901,1.38172174,5.93714947,3.53553391,3.53553391h0Z"/><path class="cls-1" d="M473.01185093,108.99794765c9.37308422,3.73224284,19.31331098,5.85013726,29.38604923,6.37204925,3.21581031.16662499,3.20677219-4.83384331,0-5-9.63451186-.49920559-19.09616918-2.62541489-28.05685117-6.19344442-1.25483236-.49965827-2.74561658.54626452-3.07529661,1.74609855-.39098707,1.4229542.48664823,2.57379952,1.74609855,3.07529661h0Z"/></svg>
<figcaption>
图2: 图 1 中的 SeqCst 操作构成的 bwcb。本图中只画出了部分箭头，传递闭包是完整的序。
</figcaption>
</figure>

第二步就是说明 $bwcb$ 添加 SeqCst 其他要求保证的序之后依旧不会成环。事实上，很大一块要添加的关系已经是 $bwcb$ 的一个子序了。

SeqCst 操作所形成的全序 $S$ 需要兼容的序包括<sup>[3]</sup>：
- Strongly happens-before，这部分可以理解为 SeqCst 操作被其他例如 AcqRel-pair 同步构成的要求。
- $([F]; sb)?; cob; (sb; [F])?$，这部分可以理解为 SC 中“顺序一致”这一要求。

## 吸收 Strongly happens-before

首先处理 SeqCst 操作之间的 Strongly happens-before，其实这已经是 $bwcb$ 的一个子序了，所以不需要额外处理：

$$
([SC]; shb; [SC]) \subset bwcb
$$

<details>
<summary>证明</summary>

Strongly happens-before 是一个关系的传递闭包，所以可能有多个中间操作，每一跳如果是 A Strongly happens-before D，可能性包括：
1. A Sequenced-before D
2. A synchronize-with D，并且 A 和 D 都是 SeqCst 操作。
3. $\exists B,C, s.t.$ A sequenced-before B, B simply happens-before C, C sequenced-before D。Simply happens-before 也是一个传递闭包，共两种情况：
    - B sequenced-before C
    - B synchronize-with C

因为我们最后要进行线性化，所以如果一个传递闭包中的一个关系有一段是第二种情况的话，可以直接切开当成前中后三段单独的关系加到要进行全序化的关系中。把剩下的所有闭包都做好，可以发现最终要考虑的关系是：

$$
sb; (sw^+; sb)^*
$$

要证明：

$$
\forall A, B \in SeqCst, A \to_{sb; (sw^+; sb)^*} B \implies end(A) \prec begin(B)
$$

### 同步操作 $\implies begin(-) \prec end(-)$

首先，如果只有一个 $sb$，根据两侧的操作都是 SeqCst，这是显然的。所以只需要考虑至少有一段 $sw^+$ 的情况，此时同样由于最两端的操作都是 SeqCst，只需证明：

$$
\forall A, B, A \to_{sw^+ ; (sb; sw^+)^*} B \implies begin(A) \prec end(B)
$$

特别地，这里 A 和 B 不需要是 SeqCst 操作。但是因为他们都参与了 $sw$，所以一定是 Acquire and/or Release 操作。我们可以对 Kleene star 的展开个数进行归纳

## $sw^+$

首先讨论只有一段 $sw^+$ 的情况，这是归纳的 Base case，也会在归纳的后续步骤中用到。

我们声称：

$$
A \to_{sw}^+ B \implies begin(A) \prec end(B)
$$

原因是，如果有 $A \to_{sw}^+ B$，那么 A 和 B 是对同一个原子对象的访问，A 是 Release 操作，B 是 Acquire 操作，并且可能有 $k \geq 0$ 个对同一个原子对象的 Acquire-Release AMO 操作：$M_1, ..., M_k$，满足：

$$
A \to_{rf} M_1 \to_{rf} ... \to_{rf} M_k \to_{rf} B
$$

根据原子操作的原子性，一定有：$A \to_{co} M_1 \to_{co} ... \to_{co} M_k$。注意到 B 读取到的是 A 或者 A 在这一原子对象 Coherence 序之后的另一个写入的值，因此 B 完成一定晚于 A 开始的时间。

另一种解释的方法是 B 读取的值依赖 A 写入的值，因此 B 完成时刻一定晚于 A 开始的时刻。<sup>[5]</sup>

## 添加 $sb; sw^+$

下面讨论归纳中的一步。如果有 $B \to_{sb} C \to_{sw}^+ D$，并且如果有 $begin(A) \prec end(B)$，那么注意 $C$ 必须是 Acquire 操作，因此 $B \to_{sb} C \implies end(B) \prec begin(C)$。把他们串起来：

$$
begin(A) \prec end(B) \prec begin(C) \prec end(D)
$$

</details>

## 顺序一致性：$([F]; sb)?; cob; (sb; [F])?$

最后剩下的就是这些关系。抄袭一下 SC11 的论文，我们把它叫作 $ppsc$ (Partial preserved SC)

$$
ppsc := ([F]; sb)?; cob; (sb; [F])?
$$

需要证明把它加入 $bwcb$ 之后不会产生环。假设如果有环存在，事实上我们可以只考虑最多有一条 $bwcb$ 边的环，如果有一个环中有多个 $bwcb$ 边，那么一定存在有一个环最多只有一个 $bwcb$ 边，其他边都是 $([F]; sb)?; cob ;(sb; [F])?$。

<details>
<summary>证明</summary>

归纳，每次通过 $bwcb$ 传递性消掉一条 $bwcb$ 边。如果环中有至少两条 $bwcb$ 边：

$$
A \to_{bwcb} B \to ... \to C \to_{bwcb} D \to ... \to A
$$

那么 $A$ 和 $B$ 不重叠，$C$ 和 $D$ 不重叠。这意味着 $C, D$ 不能同时和 $A, B$ 重叠。因此：
- 如果 $C$ 和 $A$ 不重叠，那么 $A \to_{bwcb} C \to_{bwcb} D \to ... \to A$，或者 $C \to_{bwcb} A \to_{bwcb} B \to ... \to C$，这样环可以消掉一个 $bwcb$。
- 如果 $B$ 和 $C$ 不重叠，那么 $A \to_{bwcb} B \to_{bwcb} C \to_{bwcb} D \to ... \to A$，或者 $C \to_{bwcb} B \to ... \to C$
- 如果 $D$ 和 $A$ 不重叠，那么 $C \to_{bwcb} D \to_{bwcb} A \to_{bwcb} B \to ... \to C$ 或者 $A \to_{bwcb} D \to ... \to A$
- 如果 $D$ 和 $B$ 不重叠，那么 $C \to_{bwcb} D \to_{bwcb} B \to ... \to C$ 或者 $A \to_{bwcb} B \to_{bwcb} D \to ... \to A$
</details>

因此只需考虑两个情况：有一个 $bwcb$ 边，或者没有。

### 有一条 $bwcb$ 边

此时，成环等价于存在一个 $ppsc$ 链，让链尾操作完全发生在链头操作之前。因此要证明不存在环，只需证明不存在这样的 $ppsc$ 链即可，也就是只需证：

$$
\begin{align}
& \forall A, M_1, ..., M_k, B \in SeqCst,\\
& A \to_{ppsc} M_1 \to_{ppsc} ... \to_{ppsc} M_k \to_{ppsc} B \\
\implies & begin(A) \prec end(B)
\end{align}
$$

看上去非常像归纳，但是其实归纳是证不出来的，因为每一段只能构成 $begin(-) \prec end(-)$ 的关系，这不是传递的。必须要考虑其中每个操作具体的类型。

首先一个引理：

> 如果 $A \to_{cob} B$，其中 $B$ 是一个 SeqCst 内存操作，或者 $A \to_{cob} B \to_{sb} F$，其中 $F$ 是一个 SeqCst Fence，那么 $begin(A) \prec end(B)$，或者对于 Fence 时 $begin(A) \prec end(F)$

<details>
<summary>证明</summary>

考虑 $\to_{cob}$ 这一段，由于 $cob$ 被定义为 $(rf \cup fr \cup co)^+$，除了 $cob$ 两端的操作，中间可能有其他对于同一个原子对象的 Load / Store / AMO 操作。我们再定义一个 $rf$ 的扩展：Read after $ra := co?; rf \supseteq rf$，可以理解为写入早于读取发生。我们允许这一链条中内存操作由 $ra \cup fr \cup co$ 相连。

- 首先，如果在这一链条中部（不在两端）存在 AMO 在链条中起的作用不只是其中读取一半或者写入一半产生的，那么存在另一个具有相同端点的链，其中这个 AMO 被去掉。这样我们可以把所有链条中的 AMO 都删去或者只当作普通的读取或写入。

  具体而言，如果有 $A \to_{ra \cup fr \cup co} B \to_{ra \cup fr \cup co} C$，其中 $B$ 是 AMO，和 $A$ 的关联与和 $C$ 的关联并不同时是读取的那一半或者写入的那一半，那么有两种情况：

  - $A \to_{ra} B \to_{ra \cup co} C$
  - $A \to_{fr \cup co} B \to_{fr} C$

  注意到 $fr := rf^{-1}; co$，并且根据原子操作的原子性：

  - $A \to_{ra} B \to_{ra} C \implies A \to_{co} B \to_{ra} C \implies A \to_{ra} C$
  - $A \to_{ra} B \to_{co} C \implies A \to_{co} B \to_{co} C \implies A \to_{co} C$
  - $A \to_{fr} B \to_{fr} C \implies A \to_{fr} B \to_{co} C \implies A \to_{fr} C$
  - $A \to_{co} B \to_{fr} C \implies A \to_{co} B \to_{co} C \implies A \to_{co} C$

- 随后，在链条中部的 Load 也可以被略掉。原因是在链条中部的读取只能构成如下 Pattern：

  $$
  ... A \to_{ra} B \to_{fr} C ...
  $$

  由于 $fr := rf^{-1}; co$，因此 $ra; fr = co; co = co$，所以 $A \to_{co} C$。
- 最后，多个连续的写入可以合并为一个：

  使用 $W$ 表示写，$R$ 表示读：

  - $W_A \to_{co} W_B \to_{co} W_C \implies W_A \to_{co} W_C$
  - $R_A \to_{fr} W_B \to_{co} W_C \implies R_A \to_{fr} W_C$
  - $W_A \to_{co} W_B \to_{rf} R_C \implies W_A \to_{ra} W_C$

于是在考虑 $A \to_{cob} B$ 的时候，事实上只有三种可能性。使用 $W$ 表示写入，$R$ 表示读取：

1. $W_A \to_{co} W_B$
2. $R_A \to_{fr} W_B$
3. $W_A \to_{ra} R_B$
4. $R_A \to_{fr} W_C \to_{ra} R_B$

需要证明的是 $begin(A) \prec end(B)$（或者 Fence 的情况下 $begin(A) \prec end(F)$）。前两种情况比较自然，后两种情况需要略加说明。

**对于第三种情况**，注意到对于同一原子变量的所有写入，所有核心必须以相同的顺序观测。<sup>[6]</sup> 所以如果 $W_A \to_{co} W_C \to_{rf} R_B$，那么 B 完成时，C 已经部分可见，因此 A 也已经部分可见，因此一定晚于 A 开始执行。

**对于第四种情况**，需要用到 B 是一个 SeqCst 读取（或者随后 F 是一个 SeqCst Fence）。在 B (或者 F) 完成时，根据对 SeqCst 读取的额外要求，B 读到的值必须已经全局可见了，那么 C 也必须全局可见了。注意到，$W_A \to_{fr} W_C$，因此 A 开始执行必须早于 C 全局可见的时刻。

</details>

利用这个引理，可以发现，如果我们把 $ppsc$ 链条根据 Fence 划分开来，构成由 Fence 连接的内部无 Fence 段，我们可以根据这个划分出的段数进行归纳，如果把每段两侧的 Fence 状态都完全讨论清楚的话，是可以证明的整条链条的开始操作 A 和末尾操作 B 保证 $begin(A) \prec end(B)$ 的。

<details>
<summary>证明</summary>

首先，注意到在没有 Fence 参与的情况下，$ppsc$ 就是 $cob$ 关系，而 $cob$ 传递。所以下述每段内只会写一个 $cob$。

考虑划分出的段数。如果只有一段，有四种可能性：
- 两端均无 Fence，直接使用引理。
- 开头有 Fence：$F_A \to_{sb} B \to_{cob} C$。使用引理，并且 $begin(F_A) \prec end(F_A) \prec begin(B) \prec end(C)$
- 末尾有 Fence：直接使用引理。
- 开头末尾都有 Fence：上述两种情况的方法合并即可。

接下来进行归纳。在链条末尾新加一段由 Fence 切分开的内部无 Fence 段，那么这一段一定由 Fence 开始：

- 如果目前处理这段结尾不是 Fence：已知 $A \to_{ppsc}^+ F \to_{sb} B \to_{cob} C$，根据归纳假设

  $$
  begin(A) \prec end(F) \prec begin(B) \prec end(C)
  $$

- 如果目前处理这段结尾是 Fence，处理方法完全一样。

</details>

### 无 $bwcb$ 边

此时成环直接由 $ppsc$ 成环。在讨论这样的环的存在性时，可以只考虑只有一个 Fence 的情况，因为如果有多于一个 Fence，由于 Fence 在一个时刻发生，所以两个 Fence 一定能比较先后，把环的其中一半换成 $bwcb$ 即可。

所以只需证明，不存在这样的环：

$$
F \to_{sb} A \to_{cob} B \to_{sb} F
$$

其中 A 和 B 无须是 SeqCst 操作，但 F 一定是 SeqCst Fence。使用前述引理，这一性质是显然的。

---

<div class="footnotes">

- [1] 这里依赖不是指 C++ 的没人用的 consume，而是说为了完成这个读一定需要某个操作带有的值。
- [2] 这一条是没办法完全在局部实现的，在总线上需要灌一个 Barrier 下去。不过目前唯一不支持 MCA 的（还勉强活着的）架构是 POWER，其实现仅会在 SMT 共享 Store buffer 时发生 Non-MCA 的现象，外面的缓存还是 Fully coherent and MCA 的，所以这个 Barrier 直接做成清空核心 Store Buffer 即可，代价和复杂度也不是特别高。 <!-- 不要求和其他更弱的访存操作也保持原子性。也就是说只有 SeqCst 的写入操作的生效顺序需要所有线程同意。很遗憾，这部分看上去还是需要整个缓存系统配合实现，可能需要 LLC 上有一把大锁。 -->
- [3] N4917 [atomics.order] & [intro.race]
- [4] 特别注意，如果把条件扩张成 Coherence-ordered before 之后并不能保证这件事情！核心是因为 Coherence-ordered before 是 $rf \cup fr \cup co$ 的一个传递闭包。C++ 标准做了这个闭包，结果导致了 C++ 目前标准过强，在 x86 上目前的编译是 Unsound 的，将会在下篇文章中具体讨论。[搞清楚这个细节](https://stackoverflow.com/questions/79622116/in-the-independent-read-independent-write-iriw-scenario-is-changing-loads-to)是这篇文章拖了一周的原因...
- [5] 注意，AMO 操作可能实际执行的操作不依赖之前的值（例如 exchange），但是为了保证这样的 AMO 链对于其他内存操作的排序总都有如同 carry dependency 的排序能力，内存模型通常禁止这样的 AMO 提前做 forward。其中一个例子是 RVWMO 不允许 `amoswap` 做 local-bypass。
  
  另一方面，通常所有的内存模型（语言或者硬件）都会要求对同一对象（地址）的操作有一个统一的修改顺序（Write coherence）。如果有些线程（核心）对部分距离较近的修改可见了，那么硬件必须要求这个线程（核心）之后不会忽然看到一个更老的来自其他写入突然可见。（比如如果一个 Store 从一个做 bypass 的 Store buffer 进入了一个不做 bypass 的 Store buffer，就会有这个问题）。 如果某个有 Store 成分的内存访问在其他核心变得可见的时刻一定是在自己的执行时段内（a.k.a. 上篇博客提到的“有效的回应”），那么也可以保证这样的 AMO 链能保证头尾两个访问的相互顺序（因为最后一个读取的完成时刻，一定在最早一个写入在读取发生的缓存结构处生效的时刻之后）。

  Write coherence 规则的存在导致硬件实现不能干这种事情：对于一个还没有 Commit 的写先去请求 Shared Grant，然后假装已经写入了。当这个 Grant 被 Revoke 的时候，把这个还没有发出的写直接丢掉。这种实现下，这个被丢掉的写 Effectively 被别的核心观测到的时候是在它还没开始执行时就发生了。
- [6] 见上方 [5] 中第二段开始的对于 Write coherence 的说明。

</div>
